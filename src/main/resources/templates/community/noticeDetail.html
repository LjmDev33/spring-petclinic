<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ko">

<head>
  <title th:text="${post.title}">공지사항 상세</title>
</head>

<body>
<div class="container mt-4">
  <div class="container-fluid px-0">
    <div class="row">
      <div class="col-12 d-md-flex justify-content-end px-0 gap-2">
        <!-- 관리자 전용 수정 버튼 -->
        <a sec:authorize="hasRole('ROLE_ADMIN')" class="btn btn-warning"
           th:href="@{/community/edit/{id}(id=${post.id},subject=${subject})}">
          <i class="bi bi-pencil"></i> 수정
        </a>
        <button class="btn btn-light">인쇄</button>
        <button class="btn btn-light">스크랩</button>
        <a class="btn btn-light" th:href="@{/community/list(subject=${subject})}">
          목록보기
        </a>
      </div>
    </div>

    <div class="row">
      <hr class="mt-md-2 border-2 opacity-25"/>
      <h1><span th:text="${post.title}"></span></h1>
      <hr class="mt-md-2 border-1 opacity-25"/>
      <div class="d-md-flex gap-4">
        <h3 class="mb-0">작성자 : <span class="opacity-75" th:text="${post.author}"></span></h3>
        <h3 class="mb-0">작성일 : <span class="opacity-75" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></span></h3>
        <h3 class="mb-0">조회 : <span class="opacity-75" th:text="${post.viewCount != null ? post.viewCount : 0}"></span></h3>
      </div>
    </div>

    <div class="row mt-md-2">
      <table class="table table-bordered">
        <tbody>
          <tr>
            <td class="p-4" style="min-height: 250px; max-height: 500px; overflow-y: auto;">
              <div th:utext="${post.content}"></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 좋아요 영역 (아코디언 형식, 공지사항은 답변 없음) -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="border rounded">
          <!-- 좋아요 헤더 (하트=토글, 화살표=아코디언) -->
          <div class="d-flex align-items-center px-3 py-2 bg-light border-bottom">
            <!-- 좋아요 하트 아이콘 (클릭 시 토글) -->
            <span id="likeButton" style="cursor: pointer;" th:onclick="'toggleLike(' + ${post.id} + ', event)'">
              <i id="likeIcon" th:class="${isLiked} ? 'fa fa-heart text-danger' : 'fa fa-heart-o'"></i>
            </span>
            <span class="ms-2 fw-bold">좋아요 (<span id="likeCountTab" th:text="${likeCount}">0</span>)</span>
            <!-- 아코디언 토글 화살표 -->
            <button class="btn btn-link p-0 ms-auto" type="button"
                    data-bs-toggle="collapse" data-bs-target="#likeCollapsePanel"
                    aria-expanded="false" aria-controls="likeCollapsePanel">
              <i class="fa fa-chevron-down"></i>
            </button>
          </div>

          <!-- 좋아요 아코디언 패널 -->
          <div class="collapse" id="likeCollapsePanel">
            <div class="p-4">
              <!-- 비로그인 사용자 안내 -->
              <div sec:authorize="!isAuthenticated()" class="alert alert-info text-center mb-4">
                <i class="fa fa-info-circle me-2"></i>좋아요를 누르려면 로그인이 필요합니다.
              </div>

              <!-- 좋아요 누른 사용자 목록 -->
              <div th:if="${likedUsers != null and !likedUsers.isEmpty()}">
                <h5 class="mb-3 fw-bold text-center">📌 이 글에 공감한 사용자</h5>
                <div class="row g-2">
                  <!-- 한 줄에 4명씩 배치 -->
                  <div th:each="user : ${likedUsers}" class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="d-flex align-items-center p-2 border rounded bg-light">
                      <!-- 프로필 이미지 또는 이니셜 아바타 -->
                      <div th:if="${user.hasProfileImage()}"
                           class="rounded-circle me-2 flex-shrink-0"
                           th:style="'width: 36px; height: 36px; background-image: url(' + ${user.profileImageUrl} + '); background-size: cover; background-position: center;'">
                      </div>
                      <div th:unless="${user.hasProfileImage()}"
                           class="rounded-circle me-2 flex-shrink-0 d-flex align-items-center justify-content-center text-white fw-bold"
                           th:style="'width: 36px; height: 36px; background-color: ' + ${user.avatarColor} + '; font-size: 14px;'"
                           th:text="${user.initial}">
                      </div>
                      <!-- 닉네임 -->
                      <span class="fw-bold text-truncate" th:text="${user.nickname}" th:title="${user.nickname}">사용자</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 좋아요 없을 때 안내 -->
              <div th:if="${likedUsers == null or likedUsers.isEmpty()}" class="alert alert-light text-center">
                <i class="fa fa-heart-o me-2"></i>아직 좋아요를 누른 사용자가 없습니다.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 이전글/다음글 -->
    <div class="row mt-md-4">
        <p>
          <span class="border-2 me-3 fs-6">이전글 ▲ </span>
          <span class="border-2 me-3 opacity-50">|</span>
          <span th:if="${prevPost != null}">
            <a th:href="@{/community/detail/{id}(id=${prevPost.id} , subject = ${subject})}"
               th:text="${prevPost.title}"></a>
          </span>
          <span th:if="${prevPost==null}" class="opacity-50">이전글이 없습니다.</span>
        </p>
        <hr class="mt-md-2 border-1 opacity-25"/>
        <p>
          <span class="border-2 me-3">다음글 ▼ </span>
          <span class="border-2 me-3 opacity-50">|</span>
          <span th:if="${nextPost != null}">
          <a th:href="@{/community/detail/{id}(id=${nextPost.id} , subject = ${subject})}"
            th:text="${nextPost.title}"></a>
          </span>
          <span th:if="${nextPost == null}" class="opacity-50">다음글이 없습니다</span>
        </p>
        <hr class="mt-md-2 border-1 opacity-25"/>
    </div>
  </div>

</div>

<script th:inline="javascript">
  /**
   * 좋아요 토글 (AJAX)
   * - 로그인한 사용자만 가능
   * - 하트 아이콘 및 개수 업데이트
   *
   * @param postId 게시글 ID (Thymeleaf inline으로 전달)
   */
  function toggleLike(postId, event) {
    // 이벤트 전파 방지 (아코디언 토글과 독립)
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    // CSRF 토큰 가져오기
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    // CSRF 토큰이 없으면 에러 처리
    if (!csrfToken || !csrfHeader) {
      console.error('CSRF token not found');
      if (typeof TOAST !== 'undefined') {
        TOAST.showError('보안 토큰을 찾을 수 없습니다. 페이지를 새로고침해주세요.', 3000);
      } else {
        alert('보안 토큰을 찾을 수 없습니다. 페이지를 새로고침해주세요.');
      }
      return;
    }

    // 좋아요 토글 AJAX 요청
    fetch('/community/detail/' + postId + '/like', {
      method: 'POST',
      headers: {
        [csrfHeader]: csrfToken,
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (response.status === 401) {
        // 비로그인 사용자
        throw new Error('로그인이 필요합니다.');
      }
      if (!response.ok) {
        throw new Error('서버 오류가 발생했습니다.');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // 탭의 하트 아이콘 업데이트
        const likeIcon = document.getElementById('likeIcon');
        if (data.liked) {
          // 좋아요 추가됨 (빨간 하트)
          likeIcon.className = 'fa fa-heart text-danger';
        } else {
          // 좋아요 취소됨 (빈 하트)
          likeIcon.className = 'fa fa-heart-o';
        }

        // 좋아요 개수 업데이트 (탭만)
        document.getElementById('likeCountTab').textContent = data.likeCount;

        // 성공 메시지 표시
        if (typeof TOAST !== 'undefined') {
          TOAST.showSuccess(data.message, 2000);
        } else {
          console.log(data.message);
        }
      } else {
        // 서버에서 success: false 응답
        throw new Error(data.error || '좋아요 처리에 실패했습니다.');
      }
    })
    .catch(error => {
      console.error('Like toggle error:', error);
      const errorMessage = error.message || '좋아요 처리 중 오류가 발생했습니다.';

      if (typeof TOAST !== 'undefined') {
        TOAST.showError(errorMessage, 3000);
      } else {
        alert(errorMessage);
      }
    });
  }
</script>

</body>
</html>
