<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ko">

<head>
  <title th:text="${post.title}">공지사항 상세</title>
</head>

<body>
<div class="container mt-4">
  <div class="container-fluid px-0">
    <div class="row">
      <div class="col-12 d-md-flex justify-content-end px-0 gap-2">
        <!-- 관리자 전용 수정 버튼 -->
        <a sec:authorize="hasRole('ROLE_ADMIN')" class="btn btn-warning"
           th:href="@{/community/edit/{id}(id=${post.id},subject=${subject})}">
          <i class="bi bi-pencil"></i> 수정
        </a>
        <button class="btn btn-light">인쇄</button>
        <button class="btn btn-light">스크랩</button>
        <a class="btn btn-light" th:href="@{/community/list(subject=${subject})}">
          목록보기
        </a>
      </div>
    </div>

    <div class="row">
      <hr class="mt-md-2 border-2 opacity-25"/>
      <h1><span th:text="${post.title}"></span></h1>
      <hr class="mt-md-2 border-1 opacity-25"/>
      <div class="d-md-flex gap-4">
        <h3 class="mb-0">작성자 : <span class="opacity-75" th:text="${post.author}"></span></h3>
        <h3 class="mb-0">작성일 : <span class="opacity-75" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></span></h3>
        <h3 class="mb-0">조회 : <span class="opacity-75" th:text="${post.viewCount != null ? post.viewCount : 0}"></span></h3>
      </div>
    </div>

    <div class="row mt-md-2">
      <table class="table table-bordered">
        <tbody>
          <tr>
            <td class="p-4" style="min-height: 250px; max-height: 500px; overflow-y: auto;">
              <div th:utext="${post.content}"></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 좋아요/답변 탭 영역 -->
    <div class="row mt-5">
      <div class="col-12">
        <!-- 탭 네비게이션 -->
        <ul class="nav nav-tabs" id="postTabs" role="tablist">
          <!-- 좋아요 탭 -->
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="like-tab" data-bs-toggle="tab" data-bs-target="#like-panel"
                    type="button" role="tab" aria-controls="like-panel" aria-selected="true">
              <i class="fa fa-heart"></i> 좋아요 (<span id="likeCountTab" th:text="${likeCount}">0</span>)
            </button>
          </li>
          <!-- 답변 탭 -->
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="reply-tab" data-bs-toggle="tab" data-bs-target="#reply-panel"
                    type="button" role="tab" aria-controls="reply-panel" aria-selected="false">
              <i class="fa fa-comments"></i> 답변 (<span id="replyCountTab">0</span>)
            </button>
          </li>
        </ul>

        <!-- 탭 콘텐츠 -->
        <div class="tab-content border border-top-0 rounded-bottom" id="postTabContent">
          <!-- 좋아요 탭 패널 -->
          <div class="tab-pane fade show active" id="like-panel" role="tabpanel" aria-labelledby="like-tab">
            <div class="p-5 text-center">
              <!-- 좋아요 버튼 (큰 하트) -->
              <div class="mb-4">
                <button type="button" id="likeButton" class="btn btn-link text-decoration-none p-0"
                        style="font-size: 5rem; cursor: pointer;"
                        data-post-id th:attr="data-post-id=${post.id}"
                        th:onclick="'toggleLike(' + ${post.id} + ')'">
                  <i id="likeIcon" th:class="${isLiked} ? 'fa fa-heart text-danger' : 'fa fa-heart-o text-secondary'"></i>
                </button>
              </div>
              <!-- 좋아요 개수 -->
              <h4 class="mb-3 fw-bold">
                <span id="likeCountDisplay" th:text="${likeCount}">0</span>명이 좋아합니다
              </h4>
              <!-- 비로그인 사용자 안내 -->
              <div sec:authorize="!isAuthenticated()" class="alert alert-info mt-3 d-inline-block">
                <i class="fa fa-info-circle me-2"></i>좋아요를 누르려면 로그인이 필요합니다.
              </div>
            </div>
          </div>

          <!-- 답변 탭 패널 -->
          <div class="tab-pane fade" id="reply-panel" role="tabpanel" aria-labelledby="reply-tab">
            <div class="p-4">
              <!-- 답변 토글 버튼 -->
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 fw-bold">답변 목록</h5>
                <button class="btn btn-sm btn-outline-secondary" type="button"
                        data-bs-toggle="collapse" data-bs-target="#replyListCollapse"
                        aria-expanded="false" aria-controls="replyListCollapse">
                  <i class="fa fa-chevron-down"></i> 답변 보기/숨기기
                </button>
              </div>

              <!-- 답변 목록 (접을 수 있는 영역) -->
              <div class="collapse" id="replyListCollapse">
                <div class="alert alert-secondary text-center py-5">
                  <i class="fa fa-comments" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                  <p class="mb-0 text-muted">공지사항에는 답변 기능이 제공되지 않습니다.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 이전글/다음글 -->
    <div class="row mt-md-4">
        <p>
          <span class="border-2 me-3 fs-6">이전글 ▲ </span>
          <span class="border-2 me-3 opacity-50">|</span>
          <span th:if="${prevPost != null}">
            <a th:href="@{/community/detail/{id}(id=${prevPost.id} , subject = ${subject})}"
               th:text="${prevPost.title}"></a>
          </span>
          <span th:if="${prevPost==null}" class="opacity-50">이전글이 없습니다.</span>
        </p>
        <hr class="mt-md-2 border-1 opacity-25"/>
        <p>
          <span class="border-2 me-3">다음글 ▼ </span>
          <span class="border-2 me-3 opacity-50">|</span>
          <span th:if="${nextPost != null}">
          <a th:href="@{/community/detail/{id}(id=${nextPost.id} , subject = ${subject})}"
            th:text="${nextPost.title}"></a>
          </span>
          <span th:if="${nextPost == null}" class="opacity-50">다음글이 없습니다</span>
        </p>
        <hr class="mt-md-2 border-1 opacity-25"/>
    </div>
  </div>

</div>

<script th:inline="javascript">
  /**
   * 좋아요 토글 (AJAX)
   * - 로그인한 사용자만 가능
   * - 하트 아이콘 및 개수 업데이트
   *
   * @param postId 게시글 ID (Thymeleaf inline으로 전달)
   */
  function toggleLike(postId) {
    // CSRF 토큰 가져오기
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    // CSRF 토큰이 없으면 에러 처리
    if (!csrfToken || !csrfHeader) {
      console.error('CSRF token not found');
      if (typeof TOAST !== 'undefined') {
        TOAST.showError('보안 토큰을 찾을 수 없습니다. 페이지를 새로고침해주세요.', 3000);
      } else {
        alert('보안 토큰을 찾을 수 없습니다. 페이지를 새로고침해주세요.');
      }
      return;
    }

    // 좋아요 토글 AJAX 요청
    fetch('/community/detail/' + postId + '/like', {
      method: 'POST',
      headers: {
        [csrfHeader]: csrfToken,
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (response.status === 401) {
        // 비로그인 사용자
        throw new Error('로그인이 필요합니다.');
      }
      if (!response.ok) {
        throw new Error('서버 오류가 발생했습니다.');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // 하트 아이콘 업데이트
        const likeIcon = document.getElementById('likeIcon');
        if (data.liked) {
          // 좋아요 추가됨 (빨간 하트)
          likeIcon.className = 'fa fa-heart text-danger';
        } else {
          // 좋아요 취소됨 (회색 빈 하트)
          likeIcon.className = 'fa fa-heart-o text-secondary';
        }

        // 좋아요 개수 업데이트
        document.getElementById('likeCountDisplay').textContent = data.likeCount;
        document.getElementById('likeCountTab').textContent = data.likeCount;

        // 성공 메시지 표시
        if (typeof TOAST !== 'undefined') {
          TOAST.showSuccess(data.message, 2000);
        } else {
          console.log(data.message);
        }
      } else {
        // 서버에서 success: false 응답
        throw new Error(data.error || '좋아요 처리에 실패했습니다.');
      }
    })
    .catch(error => {
      console.error('Like toggle error:', error);
      const errorMessage = error.message || '좋아요 처리 중 오류가 발생했습니다.';

      if (typeof TOAST !== 'undefined') {
        TOAST.showError(errorMessage, 3000);
      } else {
        alert(errorMessage);
      }
    });
  }
</script>

</body>
</html>
