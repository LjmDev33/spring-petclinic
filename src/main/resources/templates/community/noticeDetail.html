<!-- ê³µì§€ì‚¬í•­ ìƒì„¸ í…œí”Œë¦¿ (layout.htmlì— ì‚½ì…ë˜ëŠ” í”„ë˜ê·¸ë¨¼íŠ¸) -->
<div xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<!-- ì•„ì½”ë””ì–¸ ì• ë‹ˆë©”ì´ì…˜ CSS -->
<style>
  /* ì•„ì½”ë””ì–¸ í—¤ë” */
  .accordion-header {
    user-select: none;
    border-radius: 0;
  }

  .accordion-header:hover {
    background-color: #e9ecef !important;
    }

    /* ì•„ì½”ë””ì–¸ í† ê¸€ ì•„ì´ì½˜ (í™”ì‚´í‘œ) íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
    .accordion-toggle-icon i {
      display: inline-block;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: rotate(180deg); /* ì´ˆê¸° ìƒíƒœ: í™”ì‚´í‘œ ìœ„ ë°©í–¥ (ë‹«í˜ ìƒíƒœ) */
    }

    /* ì•„ì½”ë””ì–¸ ë³¸ë¬¸ */
    .accordion-body {
      padding: 1.5rem;
    }

    /* íŒ¨ë„ ë†’ì´ ë³€ê²½ ì• ë‹ˆë©”ì´ì…˜ (ë¶€ë“œëŸ½ê²Œ) */
    .collapse {
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      /*overflow: hidden; !* ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ë‚´ìš© ìˆ¨ê¹€ *! ìƒë‹¨ë°” ë©”ë‰´ ë˜í•œ hiddenìœ¼ë¡œ ë°”ë€œ, ì¢‹ì•„ìš”/ëŒ“ê¸€ ìš”ì†Œì—ë„ ì ìš©ë˜ëŠ” ìŠ¤íƒ€ì¼ ì—†ëŠ” ê²ƒìœ¼ë¡œ ë³´ì•„ ì£¼ì„ì²˜ë¦¬ */
    }

    .collapse.show {
      overflow: visible; /* ì—´ë¦° í›„ ë‚´ìš© í‘œì‹œ */
    }

    /* ìŠ¤í¬ë¡¤ ë™ì‘ ë¶€ë“œëŸ½ê²Œ */
    html {
      scroll-behavior: smooth;
    }

    /* ì•„ì½”ë””ì–¸ í—¤ë” í°íŠ¸ */
    .accordion-header .fw-bold {
      font-weight: 600;
      color: #212529;
    }
</style>

<div class="container mt-4">
  <div class="container-fluid px-0">
    <div class="row">
      <div class="col-12 d-md-flex justify-content-end px-0 gap-2">
        <!-- ê´€ë¦¬ì ì „ìš© ìˆ˜ì • ë²„íŠ¼ -->
        <a sec:authorize="hasRole('ROLE_ADMIN')" class="btn btn-warning"
           th:href="@{/community/edit/{id}(id=${post.id},subject=${subject})}">
          <i class="bi bi-pencil"></i> ìˆ˜ì •
        </a>
        <button class="btn btn-light">ì¸ì‡„</button>
        <button class="btn btn-light">ìŠ¤í¬ë©</button>
        <a class="btn btn-light" th:href="@{/community/list(subject=${subject})}">
          ëª©ë¡ë³´ê¸°
        </a>
      </div>
    </div>

    <div class="row">
      <hr class="mt-md-2 border-2 opacity-25"/>
      <h1><span th:text="${post.title}"></span></h1>
      <hr class="mt-md-2 border-1 opacity-25"/>
      <div class="d-md-flex gap-4">
        <h3 class="mb-0">ì‘ì„±ì : <span class="opacity-75" th:text="${post.author}"></span></h3>
        <h3 class="mb-0">ì‘ì„±ì¼ : <span class="opacity-75" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></span></h3>
        <h3 class="mb-0">ì¡°íšŒ : <span class="opacity-75" th:text="${post.viewCount != null ? post.viewCount : 0}"></span></h3>
      </div>
    </div>

    <div class="row mt-md-2">
      <table class="table table-bordered">
        <tbody>
          <tr>
            <td class="p-4" style="min-height: 250px; max-height: 500px; overflow-y: auto;">
              <div th:utext="${post.content}"></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ì¢‹ì•„ìš” íƒ­ í—¤ë” + íŒ¨ë„ ì˜ì—­ (ê³µì§€ì‚¬í•­ì€ ë‹µë³€ ì—†ìŒ) -->
    <div class="row mt-5">
      <div class="col-12">
        <!-- íƒ­ í—¤ë” (ì½˜í…ì¸  í¬ê¸°ì— ë§ê²Œ ì™¼ìª½ ì •ë ¬) -->
        <div class="border rounded-top" id="tabContainer" style="background-color: #f8f9fa; display: inline-flex; position: relative; z-index: 1;">

          <!-- ì¢‹ì•„ìš” í—¤ë” -->
          <div class="accordion-header d-flex align-items-center p-3"
               id="likeAccordionHeader"
               style="cursor: pointer; transition: background-color 0.3s ease; min-width: 150px; gap: 8px;"
               aria-expanded="false" aria-controls="likeAccordionPanel">

            <!-- ì¢‹ì•„ìš” í•˜íŠ¸ ì•„ì´ì½˜ (í´ë¦­ ì‹œ í† ê¸€) -->
            <span id="likeButton" style="cursor: pointer; font-size: 1.2rem;"
                  onclick="toggleLike(event)"
                  title="ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”">
              <i id="likeIcon" th:class="${isLiked} ? 'fa fa-heart text-danger' : 'fa fa-heart-o'"></i>
            </span>

            <!-- í…ìŠ¤íŠ¸ -->
            <span class="fw-bold">ì¢‹ì•„ìš” (<span id="likeCountTab" th:text="${likeCount}">0</span>)</span>

            <!-- ì•„ì½”ë””ì–¸ í™”ì‚´í‘œ (ì˜¤ë¥¸ìª½ ë) -->
            <span class="accordion-toggle-icon" style="display: inline-flex; align-items: center; transition: transform 0.3s ease; margin-left: auto;">
              <i class="fa fa-chevron-down"></i>
            </span>
          </div>
        </div>

        <!-- ì¢‹ì•„ìš” íŒ¨ë„ -->
        <div class="collapse border border-top-0 rounded-bottom" id="likeAccordionPanel"
             style="transition: max-height 0.3s ease;">
          <div class="accordion-body p-4 bg-light">
              <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ì•ˆë‚´ -->
              <div sec:authorize="!isAuthenticated()" class="alert alert-info text-center mb-4">
                <i class="fa fa-info-circle me-2"></i>ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
              </div>

              <!-- ì¢‹ì•„ìš” ëˆ„ë¥¸ ì‚¬ìš©ì ëª©ë¡ -->
              <div th:if="${likedUsers != null and !likedUsers.isEmpty()}">
                <h5 class="mb-3 fw-bold text-center">ğŸ“Œ ì´ ê¸€ì— ê³µê°í•œ ì‚¬ìš©ì</h5>
                <div class="row g-2">
                  <!-- í•œ ì¤„ì— 4ëª…ì”© ë°°ì¹˜ -->
                  <div th:each="user : ${likedUsers}" class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="d-flex align-items-center p-2 border rounded bg-light">
                      <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ë˜ëŠ” ì´ë‹ˆì…œ ì•„ë°”íƒ€ -->
                      <div th:if="${user.hasProfileImage()}"
                           class="rounded-circle me-2 flex-shrink-0"
                           th:style="'width: 36px; height: 36px; background-image: url(' + ${user.profileImageUrl} + '); background-size: cover; background-position: center;'">
                      </div>
                      <div th:unless="${user.hasProfileImage()}"
                           class="rounded-circle me-2 flex-shrink-0 d-flex align-items-center justify-content-center text-white fw-bold"
                           th:style="'width: 36px; height: 36px; background-color: ' + ${user.avatarColor} + '; font-size: 14px;'"
                           th:text="${user.initial}">
                      </div>
                      <!-- ë‹‰ë„¤ì„ -->
                      <span class="fw-bold text-truncate" th:text="${user.nickname}" th:title="${user.nickname}">ì‚¬ìš©ì</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ì¢‹ì•„ìš” ì—†ì„ ë•Œ ì•ˆë‚´ -->
              <div th:if="${likedUsers == null or likedUsers.isEmpty()}" class="alert alert-light text-center">
                <i class="fa fa-heart-o me-2"></i>ì•„ì§ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
              </div>
          </div> <!-- /accordion-body -->
        </div> <!-- /likeAccordionPanel -->

      </div> <!-- /col-12 -->
    </div> <!-- /row -->

    <!-- ì´ì „ê¸€/ë‹¤ìŒê¸€ -->
    <div class="row mt-md-4">
        <p>
          <span class="border-2 me-3 fs-6">ì´ì „ê¸€ â–² </span>
          <span class="border-2 me-3 opacity-50">|</span>
          <span th:if="${prevPost != null}">
            <a th:href="@{/community/detail/{id}(id=${prevPost.id} , subject = ${subject})}"
               th:text="${prevPost.title}"></a>
          </span>
          <span th:if="${prevPost==null}" class="opacity-50">ì´ì „ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</span>
        </p>
        <hr class="mt-md-2 border-1 opacity-25"/>
        <p>
          <span class="border-2 me-3">ë‹¤ìŒê¸€ â–¼ </span>
          <span class="border-2 me-3 opacity-50">|</span>
          <span th:if="${nextPost != null}">
          <a th:href="@{/community/detail/{id}(id=${nextPost.id} , subject = ${subject})}"
            th:text="${nextPost.title}"></a>
          </span>
          <span th:if="${nextPost == null}" class="opacity-50">ë‹¤ìŒê¸€ì´ ì—†ìŠµë‹ˆë‹¤</span>
        </p>
        <hr class="mt-md-2 border-1 opacity-25"/>
    </div>
  </div>

</div>

<!-- ì˜¤ë¥˜ ì•Œë¦¼ ì‹œìŠ¤í…œ JS -->
<script th:src="@{/js/error-notification.js}"></script>

<script th:inline="javascript">
  /**
   * í˜ì´ì§€ ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
   */
  document.addEventListener('DOMContentLoaded', function() {
    // === ì•„ì½”ë””ì–¸ íŒ¨ë„ ì´ˆê¸° ìƒíƒœ ê°•ì œ ì„¤ì • ===
    const likePanel = document.getElementById('likeAccordionPanel');
    const likeHeader = document.getElementById('likeAccordionHeader');

    // ì¢‹ì•„ìš” íŒ¨ë„: ë‹«í˜ ìƒíƒœ ê°•ì œ ì„¤ì •
    if (likePanel) {
      likePanel.classList.remove('show');
      likePanel.style.height = '';
    }

    // í™”ì‚´í‘œ ì´ˆê¸° ë°©í–¥ ê°•ì œ ì„¤ì •
    // ì¢‹ì•„ìš”: ë‹«í˜ â†’ ìœ„ ë°©í–¥ (180deg)
    if (likeHeader) {
      const likeIcon = likeHeader.querySelector('.accordion-toggle-icon i');
      if (likeIcon) {
        likeIcon.style.transform = 'rotate(180deg)'; // ìœ„ ë°©í–¥
      }
    }
  });

  /**
   * ì¢‹ì•„ìš” í† ê¸€ (AJAX)
   * - ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê°€ëŠ¥
   * - í•˜íŠ¸ ì•„ì´ì½˜ ë° ê°œìˆ˜ ì—…ë°ì´íŠ¸
   * - ì•„ì½”ë””ì–¸ í¼ì¹¨/ì ‘í˜ê³¼ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘
   */
  function toggleLike(event) {
    // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ (ì•„ì½”ë””ì–¸ í† ê¸€ê³¼ ë…ë¦½)
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    const postId = /*[[${post.id}]]*/ '';
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch('/community/detail/' + postId + '/like', {
      method: 'POST',
      headers: {
        [csrfHeader]: csrfToken,
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // íƒ­ì˜ í•˜íŠ¸ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
        const likeIcon = document.getElementById('likeIcon');
        if (data.liked) {
          // ì¢‹ì•„ìš” ì¶”ê°€ë¨ (ë¹¨ê°„ í•˜íŠ¸)
          likeIcon.className = 'fa fa-heart text-danger';
        } else {
          // ì¢‹ì•„ìš” ì·¨ì†Œë¨ (ë¹ˆ í•˜íŠ¸)
          likeIcon.className = 'fa fa-heart-o';
        }

        // ì¢‹ì•„ìš” ê°œìˆ˜ ì—…ë°ì´íŠ¸ (íƒ­ë§Œ)
        document.getElementById('likeCountTab').textContent = data.likeCount;

        // Toast ì•Œë¦¼
        TOAST.showSuccess(data.message, 2000);
      } else {
        // ì—ëŸ¬ (ë¹„ë¡œê·¸ì¸ ë“±)
        TOAST.showError(data.error, 3000);
      }
    })
    .catch(error => {
      console.error('Like toggle error:', error);
      TOAST.showError('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 3000);
    });
  }

  /**
   * ì•„ì½”ë””ì–¸ ë™ì‘ + í™”ì‚´í‘œ íšŒì „ ì• ë‹ˆë©”ì´ì…˜
   * - ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€ (í˜ì´ì§€ ì í”„ ë°©ì§€)
   */
  (function initAccordionBehavior() {
    const likePanel = document.getElementById('likeAccordionPanel');
    const likeHeader = document.getElementById('likeAccordionHeader');
    const likeToggleIcon = likeHeader.querySelector('.accordion-toggle-icon i');

    // === í—¤ë” í´ë¦­ ì‹œ ìŠ¤í¬ë¡¤ ë°©ì§€ + ìˆ˜ë™ í† ê¸€ ===
    likeHeader.addEventListener('click', function(e) {
      e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ìŠ¤í¬ë¡¤ ì í”„ ë°©ì§€)
      const likeCollapse = bootstrap.Collapse.getOrCreateInstance(likePanel);
      likeCollapse.toggle(); // ìˆ˜ë™ í† ê¸€
    });

    // === ì¢‹ì•„ìš” íŒ¨ë„ ì´ë²¤íŠ¸ ===
    likePanel.addEventListener('show.bs.collapse', function() {
      // ì¢‹ì•„ìš” íŒ¨ë„ ì—´ê¸° â†’ í™”ì‚´í‘œ ì•„ë˜ ë°©í–¥ (0deg)
      if (likeToggleIcon) {
        likeToggleIcon.style.transform = 'rotate(0deg)';
      }
    });

    likePanel.addEventListener('hide.bs.collapse', function() {
      // ì¢‹ì•„ìš” íŒ¨ë„ ë‹«ê¸° â†’ í™”ì‚´í‘œ ìœ„ ë°©í–¥ (180deg)
      if (likeToggleIcon) {
        likeToggleIcon.style.transform = 'rotate(180deg)';
      }
    });

    // === í—¤ë” í˜¸ë²„ íš¨ê³¼ ===
    likeHeader.addEventListener('mouseenter', function() {
      this.style.backgroundColor = '#e9ecef';
    });
    likeHeader.addEventListener('mouseleave', function() {
      this.style.backgroundColor = '#f8f9fa';
    });
  })();
</script>

</div> <!-- /wrapper div -->
