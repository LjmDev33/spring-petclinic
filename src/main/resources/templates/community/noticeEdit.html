<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ko">
<head>
  <title>공지사항 수정 - Spring PetClinic</title>
  <!-- Quill Editor CSS (로컬 내장) -->
  <link rel="stylesheet" th:href="@{/css/quill/quill.snow.css}">
  <!-- Uppy CSS (로컬 내장) - Phase 3 -->
  <link rel="stylesheet" th:href="@{/css/uppy/uppy-custom.css}">
  <link rel="stylesheet" th:href="@{/css/uppy/upload-modal.css}">
  <link rel="stylesheet" th:href="@{/css/custom-buttons.css}">
  <!-- 오류 알림 시스템 CSS -->
  <link rel="stylesheet" th:href="@{/css/error-notification.css}">
</head>
<body>
<div class="container mt-4">
  <!-- 헤더: 제목 + 취소/목록 버튼 -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="bi bi-pencil-square"></i> 공지사항 수정
    </h2>
    <div class="d-flex" style="gap: 8px;">
      <a th:href="@{/community/detail/{id}(id=${post.id},subject='notice')}" class="custom-btn custom-btn-secondary">
        <i class="bi bi-arrow-left me-1"></i> 취소
      </a>
      <a th:href="@{/community/list(subject='notice')}" class="custom-btn custom-btn-secondary">
        <i class="bi bi-list me-1"></i> 목록
      </a>
    </div>
  </div>

  <!-- 관리자 전용 안내 -->
  <div class="alert alert-info" role="alert">
    <i class="bi bi-info-circle"></i>
    <strong>관리자 전용</strong> - 공지사항은 관리자만 수정할 수 있습니다.
  </div>

  <form id="editForm" th:action="@{/community/edit/{id}(id=${post.id})}" method="post">
    <input type="hidden" name="subject" value="notice">

    <!-- 제목 입력 -->
    <div class="mb-3">
      <label for="title" class="form-label">
        <i class="bi bi-megaphone"></i> 제목 <span class="text-danger">*</span>
      </label>
      <input type="text" id="title" name="title" class="form-control" th:value="${post.title}" required>
    </div>

    <!-- 작성자 -->
    <div class="mb-3">
      <label for="author" class="form-label">
        <i class="bi bi-person"></i> 작성자
      </label>
      <input type="text" id="author" name="author" class="form-control" th:value="${post.author}" readonly>
      <small class="form-text text-muted">관리자 이름이 자동으로 표시됩니다.</small>
    </div>

    <!-- 에디터 영역 -->
    <div class="mb-3">
      <label class="form-label">
        <i class="bi bi-file-text"></i> 내용 <span class="text-danger">*</span>
      </label>
      <div id="editor" style="height: 400px;"></div>
      <textarea name="content" id="content" hidden></textarea>
    </div>

    <!-- 기존 첨부파일 목록 (Phase 3) -->
    <div class="mb-3" th:if="${post.attachments != null and !post.attachments.isEmpty()}">
      <label class="form-label">
        <i class="bi bi-paperclip"></i> 기존 첨부파일
      </label>
      <ul class="list-group" id="existingFilesList">
        <li class="list-group-item d-flex justify-content-between align-items-center"
            th:each="file : ${post.attachments}"
            th:data-file-id="${file.id}">
          <div>
            <i class="bi bi-file-earmark"></i>
            <span th:text="${file.originalFileName}"></span>
            <span class="badge bg-secondary rounded-pill ms-2"
                  th:text="${#numbers.formatDecimal(file.fileSize / 1024, 1, 2)} + ' KB'"></span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger"
                  th:onclick="'removeExistingFile(' + ${file.id} + ')'">
            <i class="bi bi-trash"></i> 삭제
          </button>
        </li>
      </ul>
      <!-- 삭제할 파일 ID 목록 (쉼표 구분) -->
      <input type="hidden" id="deletedFileIds" name="deletedFileIds" value="">
    </div>

    <!-- 새 첨부파일 추가 (Uppy Dashboard) - Phase 3 -->
    <div class="mb-3">
      <label class="form-label">
        <i class="bi bi-paperclip"></i> 새 첨부파일 추가
      </label>
      <!-- 실제 서버 전송용 hidden input (Uppy 업로드된 파일 경로, 쉼표 구분) -->
      <input type="hidden" id="attachmentPaths" name="attachmentPaths">
      <!-- Uppy Dashboard가 렌더링될 영역 -->
      <div id="uppy-dashboard" class="border rounded p-2"></div>
      <small class="form-text text-muted">
        이미지, 문서(PDF, Word, Excel, 한글), 압축 파일을 업로드할 수 있으며, 파일당 최대 10MB, 최대 5개까지 업로드할 수 있습니다.
      </small>
    </div>

    <!-- 버튼 영역 -->
    <div class="d-flex justify-content-end mt-4" style="gap: 8px;">
      <a th:href="@{/community/detail/{id}(id=${post.id},subject='notice')}" class="custom-btn custom-btn-secondary">
        <i class="bi bi-x-lg me-1"></i> 취소
      </a>
      <button type="submit" class="custom-btn custom-btn-primary" id="submitBtn">
        <i class="bi bi-save me-1"></i> 수정 완료
      </button>
    </div>
  </form>
</div>

<!-- 업로드 모달 (Phase 3) -->
<div id="uploadModal" class="upload-modal-overlay" style="display: none;">
  <div class="upload-modal">
    <div class="upload-modal-header">
      <h3 class="upload-modal-title">
        <span class="upload-spinner"></span>
        파일 업로드 중
      </h3>
      <p class="upload-modal-subtitle" id="uploadModalSubtitle">업로드를 준비하고 있습니다...</p>
    </div>
    <div class="upload-modal-body">
      <div class="upload-modal-progress">
        <div class="upload-modal-progress-bar">
          <div class="upload-modal-progress-fill" id="uploadModalProgressFill" style="width: 0%;"></div>
          <div class="upload-modal-progress-text" id="uploadModalProgressText">0%</div>
        </div>
      </div>
      <div class="upload-modal-status" id="uploadModalStatus">
        파일을 업로드하고 있습니다...
      </div>
    </div>
  </div>
</div>

<!-- Quill Editor JS (로컬 내장) -->
<script th:src="@{/js/quill/quill.js}"></script>

<!-- Uppy JS (로컬 내장 브라우저 번들) - Phase 3 -->
<script th:src="@{/js/uppy/uppy-browser.js}"></script>

<!-- 오류 알림 시스템 JS -->
<script th:src="@{/js/error-notification.js}"></script>

<script th:inline="javascript">
  // 기존 파일 삭제 처리 (Phase 3)
  const deletedFileIdsSet = new Set();

  function removeExistingFile(fileId) {
    try {
      const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
      const fileName = fileItem ? fileItem.querySelector('span')?.textContent : '파일';

      if (confirm(`"${fileName}"을(를) 삭제하시겠습니까?\n\n※ 게시글 수정을 완료해야 실제로 삭제됩니다.`)) {
        deletedFileIdsSet.add(fileId);
        document.getElementById('deletedFileIds').value = Array.from(deletedFileIdsSet).join(',');

        // UI에서 해당 파일 항목 제거
        if (fileItem) {
          fileItem.style.transition = 'opacity 0.3s';
          fileItem.style.opacity = '0';
          setTimeout(() => {
            fileItem.remove();
            if (typeof ErrorNotification !== 'undefined') {
              ErrorNotification.showToast(
                '파일 삭제 예약',
                `"${fileName}" 파일이 삭제 예약되었습니다. 수정을 완료하면 삭제됩니다.`,
                'success',
                3000
              );
            }
          }, 300);
        }

        console.log('File marked for deletion:', fileId);
      }
    } catch (error) {
      console.error('Error removing file:', error);
      alert('파일 삭제 처리 중 오류가 발생했습니다: ' + error.message);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Quill Editor 초기화
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'align': [] }],
          ['link'],
          ['clean']
        ]
      },
      placeholder: '공지사항 내용을 입력하세요...'
    });

    // 기존 게시글 내용을 에디터에 로드
    const existingContent = /*[[${post.content}]]*/ '';
    if (existingContent) {
      quill.root.innerHTML = existingContent;
    }

    // Uppy 초기화 (Phase 3)
    const uppy = new Uppy.Core({
      autoProceed: false,
      restrictions: {
        maxNumberOfFiles: 5,
        maxFileSize: 10 * 1024 * 1024,
        allowedFileTypes: [
          'image/*', '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.hwp', '.txt', '.zip', '.rar'
        ]
      }
    });

    uppy.use(Uppy.Dashboard, {
      inline: true,
      target: '#uppy-dashboard',
      proudlyDisplayPoweredByUppy: false,
      height: 200,
      locale: {
        strings: {
          dropPasteImportBoth: '파일을 드래그하거나 %{browse}하세요',
          browse: '선택',
          uploadXFiles: {
            0: '%{smart_count}개 파일 업로드',
            1: '%{smart_count}개 파일 업로드'
          }
        }
      }
    });

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    uppy.use(Uppy.XHRUpload, {
      endpoint: '/community/upload-temp',
      fieldName: 'files',
      formData: true,
      headers: {
        [csrfHeader]: csrfToken
      }
    });

    // 모달 요소
    const uploadModal = document.getElementById('uploadModal');
    const uploadModalProgressFill = document.getElementById('uploadModalProgressFill');
    const uploadModalProgressText = document.getElementById('uploadModalProgressText');

    uppy.on('upload-start', () => {
      uploadModal.style.display = 'flex';
      uploadModalProgressFill.style.width = '0%';
      uploadModalProgressText.textContent = '0%';
    });

    uppy.on('upload-progress', (file, progress) => {
      const percentage = Math.round((progress.bytesUploaded / progress.bytesTotal) * 100);
      uploadModalProgressFill.style.width = percentage + '%';
      uploadModalProgressText.textContent = percentage + '%';
    });

    uppy.on('complete', (result) => {
      uploadModal.style.display = 'none';

      if (result.successful && result.successful.length > 0) {
        const paths = result.successful.map(file => file.response.body[0].path).join(',');
        document.getElementById('attachmentPaths').value = paths;
        console.log('Uploaded paths:', paths);
      }
    });

    // 폼 제출 시 에디터 내용을 textarea에 동기화
    const form = document.getElementById('editForm');
    form.addEventListener('submit', function(e) {
      const contentTextarea = document.getElementById('content');
      contentTextarea.value = quill.root.innerHTML;

      // 내용 필수 검증
      if (!contentTextarea.value || contentTextarea.value.trim() === '<p><br></p>' || contentTextarea.value.trim() === '') {
        e.preventDefault();
        alert('내용을 입력해주세요.');
        return false;
      }

      // 제출 버튼 비활성화 (중복 제출 방지)
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> 수정 중...';
    });
  });
</script>
</body>
</html>

