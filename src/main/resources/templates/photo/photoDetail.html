<!-- í¬í†  ìƒì„¸ í…œí”Œë¦¿ (layout.htmlì— ì‚½ì…ë˜ëŠ” í”„ë˜ê·¸ë¨¼íŠ¸) -->
<div xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<!-- ì•„ì½”ë””ì–¸ ì• ë‹ˆë©”ì´ì…˜ CSS -->
<style>
  .thumbnail-preview {
    width: 100%;
    max-height: 400px;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  /* ì•„ì½”ë””ì–¸ í—¤ë” */
    .accordion-header {
      user-select: none;
      border-radius: 0;
    }

    .accordion-header:hover {
      background-color: #e9ecef !important;
    }

    /* ì•„ì½”ë””ì–¸ í† ê¸€ ì•„ì´ì½˜ (í™”ì‚´í‘œ) íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
    .accordion-toggle-icon i {
      display: inline-block;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: rotate(180deg); /* ì´ˆê¸° ìƒíƒœ: í™”ì‚´í‘œ ìœ„ ë°©í–¥ (ë‹«í˜ ìƒíƒœ) */
    }

    /* ì•„ì½”ë””ì–¸ ë³¸ë¬¸ */
    .accordion-body {
      padding: 1.5rem;
    }

    /* íŒ¨ë„ ë†’ì´ ë³€ê²½ ì• ë‹ˆë©”ì´ì…˜ (ë¶€ë“œëŸ½ê²Œ) */
    .collapse {
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      /*overflow: hidden; !* ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ë‚´ìš© ìˆ¨ê¹€ *! ìƒë‹¨ë°” ë©”ë‰´ ë˜í•œ hiddenìœ¼ë¡œ ë°”ë€œ, ì¢‹ì•„ìš”/ëŒ“ê¸€ ìš”ì†Œì—ë„ ì ìš©ë˜ëŠ” ìŠ¤íƒ€ì¼ ì—†ëŠ” ê²ƒìœ¼ë¡œ ë³´ì•„ ì£¼ì„ì²˜ë¦¬ */
    }

    .collapse.show {
      overflow: visible; /* ì—´ë¦° í›„ ë‚´ìš© í‘œì‹œ */
    }

    /* ìŠ¤í¬ë¡¤ ë™ì‘ ë¶€ë“œëŸ½ê²Œ */
    html {
      scroll-behavior: smooth;
    }

    /* ì•„ì½”ë””ì–¸ í—¤ë” í°íŠ¸ */
    .accordion-header .fw-bold {
      font-weight: 600;
      color: #212529;
    }
</style>

<div class="container mt-4">
  <!-- ë²„íŠ¼ ê·¸ë£¹ -->
  <div class="d-flex justify-content-between mb-3">
    <div class="d-flex" style="gap: 8px;" th:if="${ownerYN == true}">
      <a th:href="@{/photo/edit/{id}(id=${post.id})}" class="btn btn-outline-dark">
        <i class="bi bi-pencil me-1"></i> ìˆ˜ì •
      </a>
      <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
        <i class="bi bi-trash me-1"></i> ì‚­ì œ
      </button>
    </div>
    <a th:href="@{/photo/list}" class="btn btn-light">
      <i class="bi bi-list me-1"></i> ëª©ë¡
    </a>
  </div>

  <!-- ì œëª© ë° ë©”íƒ€ ì •ë³´ -->
  <div class="row">
    <hr class="mt-2 border-2 opacity-25"/>
    <h1><span th:text="${post.title}"></span></h1>
    <hr class="mt-2 border-1 opacity-25"/>
    <div class="d-md-flex gap-4">
      <h3 class="mb-0">ì‘ì„±ì : <span class="opacity-75" th:text="${post.author}"></span></h3>
      <h3 class="mb-0">ì‘ì„±ì¼ : <span class="opacity-75" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span></h3>
      <h3 class="mb-0">ì¡°íšŒ : <span class="opacity-75" th:text="${post.viewCount}"></span></h3>
      <h3 class="mb-0">ì¢‹ì•„ìš” : <span class="opacity-75" th:text="${post.likeCount}"></span></h3>
    </div>
  </div>

  <!-- ë³¸ë¬¸ ë‚´ìš© (Quill ì—ë””í„° ìŠ¤íƒ€ì¼ ì ìš©) -->
  <div class="row mt-3">
    <div class="table table-bordered">
      <div class="p-3 ql-editor" th:utext="${post.content}"></div>
    </div>
  </div>

  <!-- ì¢‹ì•„ìš”/ë‹µë³€ íƒ­ í—¤ë” + íŒ¨ë„ ì˜ì—­ -->
  <div class="row mt-5">
    <div class="col-12">
      <!-- íƒ­ í—¤ë” (ì½˜í…ì¸  í¬ê¸°ì— ë§ê²Œ ì™¼ìª½ ì •ë ¬) -->
      <div class="border rounded-top" id="tabContainer" style="background-color: #f8f9fa; display: inline-flex; position: relative; z-index: 1;">

        <!-- ì¢‹ì•„ìš” í—¤ë” -->
        <div class="accordion-header d-flex align-items-center p-3"
             id="likeAccordionHeader"
             style="cursor: pointer; transition: background-color 0.3s ease; min-width: 150px; border-right: 1px solid #dee2e6; gap: 8px;"
             aria-expanded="false" aria-controls="likeAccordionPanel">

          <!-- ì¢‹ì•„ìš” í•˜íŠ¸ ì•„ì´ì½˜ (í´ë¦­ ì‹œ í† ê¸€) -->
          <span id="likeButton" style="cursor: pointer; font-size: 1.2rem;"
                onclick="toggleLike(event)"
                title="ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”">
            <i id="likeIcon" th:class="${isLiked} ? 'fa fa-heart text-danger' : 'fa fa-heart-o'"></i>
          </span>

          <!-- í…ìŠ¤íŠ¸ -->
          <span class="fw-bold">ì¢‹ì•„ìš” (<span id="likeCountTab" th:text="${likeCount}">0</span>)</span>

          <!-- ì•„ì½”ë””ì–¸ í™”ì‚´í‘œ (ì˜¤ë¥¸ìª½ ë) -->
          <span class="accordion-toggle-icon" style="display: inline-flex; align-items-center; transition: transform 0.3s ease; margin-left: auto;">
            <i class="fa fa-chevron-down"></i>
          </span>
        </div>

        <!-- ë‹µë³€ í—¤ë” -->
        <div class="accordion-header d-flex align-items-center p-3"
             id="commentAccordionHeader"
             style="cursor: pointer; transition: background-color 0.3s ease; min-width: 150px; gap: 8px;"
             aria-expanded="true" aria-controls="commentAccordionPanel">

          <!-- ì±„íŒ… ì•„ì´ì½˜ -->
          <i class="bi bi-chat-dots"></i>

          <!-- í…ìŠ¤íŠ¸ -->
          <span class="fw-bold">ë‹µë³€ (<span th:text="${#lists.size(comments)}">0</span>)</span>

          <!-- ì•„ì½”ë””ì–¸ í™”ì‚´í‘œ (ì˜¤ë¥¸ìª½ ë) -->
          <span class="accordion-toggle-icon" style="display: inline-flex; align-items-center; transition: transform 0.3s ease; margin-left: auto;">
            <i class="fa fa-chevron-down"></i>
          </span>
        </div>
      </div>

      <!-- ì¢‹ì•„ìš” íŒ¨ë„ -->
      <div class="collapse border border-top-0 rounded-bottom" id="likeAccordionPanel"
           style="transition: max-height 0.3s ease;">
        <div class="accordion-body p-4 bg-light">
          <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ì•ˆë‚´ -->
          <div sec:authorize="!isAuthenticated()" class="alert alert-info text-center mb-4">
            <i class="fa fa-info-circle me-2"></i>ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
          </div>

          <!-- ì¢‹ì•„ìš” ëˆ„ë¥¸ ì‚¬ìš©ì ëª©ë¡ -->
          <div id="likedUsersContainer">
            <div th:if="${likedUsers != null and !likedUsers.isEmpty()}">
              <h5 class="mb-3 fw-bold text-center">ğŸ“Œ ì´ ê¸€ì— ê³µê°í•œ ì‚¬ìš©ì</h5>
              <div class="row g-2">
                <div th:each="user : ${likedUsers}" class="col-12 col-sm-6 col-md-4 col-lg-3">
                  <div class="d-flex align-items-center p-2 border rounded bg-light">
                    <div th:if="${user.hasProfileImage()}"
                         class="rounded-circle me-2 flex-shrink-0"
                         th:style="'width: 36px; height: 36px; background-image: url(' + ${user.profileImageUrl} + '); background-size: cover; background-position: center;'">
                    </div>
                    <div th:unless="${user.hasProfileImage()}"
                         class="rounded-circle me-2 flex-shrink-0 d-flex align-items-center justify-content-center text-white fw-bold"
                         th:style="'width: 36px; height: 36px; background-color: ' + ${user.avatarColor} + '; font-size: 14px;'"
                         th:text="${user.initial}">
                    </div>
                    <span class="fw-bold text-truncate" th:text="${user.nickname}" th:title="${user.nickname}">ì‚¬ìš©ì</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div th:if="${likedUsers == null or likedUsers.isEmpty()}" class="alert alert-light text-center">
            <i class="fa fa-heart-o me-2"></i>ì•„ì§ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        </div> <!-- /accordion-body -->
      </div> <!-- /likeAccordionPanel -->

      <!-- ë‹µë³€ íŒ¨ë„ (ì´ˆê¸° ìƒíƒœ: ì—´ë¦¼) -->
      <div class="collapse show border border-top-0 rounded-bottom" id="commentAccordionPanel"
           style="transition: max-height 0.3s ease;">
        <div class="accordion-body p-4">

          <div id="commentsContainer">
            <div th:if="${#lists.isEmpty(comments)}" class="alert alert-light text-center py-5">
              <i class="bi bi-chat-text fs-1 text-muted"></i>
              <p class="mt-3 mb-0 text-muted">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            </div>

            <div th:if="${!#lists.isEmpty(comments)}">
              <div class="comments-container">
                <th:block th:each="comment : ${comments}">
                  <th:block th:replace="~{:: renderComment(${comment})}"></th:block>
                </th:block>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end mt-4">
            <button type="button" class="btn btn-primary"
                    data-bs-toggle="modal" data-bs-target="#commentWriteModal"
                    id="openCommentModalBtn">
              <i class="bi bi-pencil-square"></i> ëŒ“ê¸€ ì‘ì„±
            </button>
          </div>

        </div> <th:block th:fragment="renderComment(c)">
        <div th:if="${c != null}">
          <div class="comment-item mb-2"
               th:style="${(c.depth != null && c.depth > 0) ? 'margin-left: ' + (c.depth * 48) + 'px; padding-left: 20px; border-left: 3px solid #e3f2fd;' : ''}">

            <div th:if="${c.depth != null && c.depth > 0 && c.parentAuthorName != null}"
                 class="reply-target-info mb-1"
                 style="font-size: 0.75rem; color: #0d6efd; font-weight: 500;">
              <i class="bi bi-arrow-return-right me-1"></i>
              <span th:text="'@' + ${c.parentAuthorName} + 'ë‹˜ì—ê²Œ ë‹µê¸€'"></span>
            </div>

            <div class="card shadow-sm border-0"
                 th:style="${c.staffReply ? 'border-left: 3px solid #198754 !important; border-radius: 6px; background-color: #f0fdf4;' : ((c.depth != null && c.depth > 0) ? 'border-radius: 6px; background-color: #f8f9fa;' : 'border-radius: 6px;')}">
              <div class="card-body p-2 p-md-3">
                <div class="d-flex align-items-start mb-2">
                  <div class="flex-shrink-0">
                    <div class="avatar-circle text-white d-flex align-items-center justify-content-center"
                         th:classappend="${(c.depth != null && c.depth > 0) ? 'bg-info' : 'bg-primary'}"
                         th:style="${(c.depth != null && c.depth > 0) ? 'width: 32px; height: 32px; font-size: 13px;' : 'width: 36px; height: 36px; font-size: 16px;'} + 'border-radius: 50%; font-weight: bold;'">
                      <span th:text="${#strings.substring(c.authorName, 0, 1)}">ì‘</span>
                    </div>
                  </div>
                  <div class="flex-grow-1 ms-2">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <strong th:style="${(c.depth != null && c.depth > 0) ? 'font-size: 0.85rem;' : 'font-size: 0.95rem;'}"
                                th:text="${c.authorName}"></strong>
                        <span th:if="${c.depth != null && c.depth > 0}" class="badge bg-info ms-1" style="font-size: 0.65rem;">
                         <i class="bi bi-reply-fill"></i> ë‹µê¸€
                       </span>
                        <span th:if="${c.staffReply}" class="badge bg-success ms-1" style="font-size: 0.7rem;">
                         <i class="bi bi-shield-check"></i> ìš´ì˜ì
                       </span>
                      </div>
                      <small class="text-muted" th:text="${#temporals.format(c.createdAt, 'MM-dd HH:mm')}"></small>
                    </div>
                  </div>
                </div>

                <div class="comment-content ps-0 ps-md-5 mb-2"
                     th:text="${c.content}"
                     style="word-break: break-word; white-space: pre-wrap;"></div>

                <div class="d-flex justify-content-end ps-0 ps-md-5 gap-1">
                  <button type="button" class="btn btn-sm btn-outline-primary reply-btn"
                          data-bs-toggle="modal" data-bs-target="#commentWriteModal"
                          th:attr="data-comment-id=${c.id},data-author-name=${c.authorName}">
                    <i class="bi bi-reply"></i> ë‹µê¸€
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-danger delete-comment-btn"
                          th:if="${!c.staffReply}"
                          th:attr="data-comment-id=${c.id},data-has-password=${c.passwordHash != null}">
                    <i class="bi bi-trash"></i> ì‚­ì œ
                  </button>
                </div>
              </div>
            </div>
          </div>

          <th:block th:if="${!#lists.isEmpty(c.children)}">
            <th:block th:each="child : ${c.children}">
              <th:block th:replace="~{:: renderComment(${child})}"></th:block>
            </th:block>
          </th:block>
        </div>
      </th:block>

        <div class="modal fade" id="commentWriteModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> <span id="modalTitle">ëŒ“ê¸€ ì‘ì„±</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <form id="commentForm" onsubmit="submitCommentAjax(event)">
                <div class="modal-body">
                  <div id="replyToInfo" class="alert alert-info" style="display: none;">
                    <i class="bi bi-reply"></i> <strong><span id="replyToName"></span></strong>ë‹˜ì—ê²Œ ë‹µê¸€ ì‘ì„± ì¤‘
                    <button type="button" class="btn-close float-end" onclick="resetCommentModal()"></button>
                  </div>
                  <input type="hidden" id="parentId" name="parentId" value="">

                  <div class="mb-3">
                    <label class="form-label">ì´ë¦„ <span class="text-danger">*</span></label>
                    <input type="text" id="commentAuthor" name="authorName" class="form-control"
                           th:value="${#authentication.name == 'anonymousUser' ? '' : #authentication.principal.nickname}" required>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">ë¹„ë°€ë²ˆí˜¸ (ì„ íƒ)</label>
                    <input type="password" id="commentPassword" name="password" class="form-control" placeholder="ì‚­ì œ ì‹œ í•„ìš”">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">ë‚´ìš© <span class="text-danger">*</span></label>
                    <textarea id="commentContent" name="content" class="form-control" rows="4" required></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                  <button type="submit" class="btn btn-primary" id="submitCommentBtn">ë“±ë¡</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="modal fade" id="deleteCommentModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">ëŒ“ê¸€ ì‚­ì œ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <form id="deleteCommentForm" onsubmit="deleteCommentAjax(event)">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="modal-body">
                  <p>ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                  <div class="mb-3" id="commentPasswordGroup" style="display: none;">
                    <input type="password" id="commentDeletePassword" name="password" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" >
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                  <button type="submit" class="btn btn-danger">ì‚­ì œ</button>
                </div>
              </form>
            </div>
          </div>
        </div> <!-- /accordion-body -->
      </div> <!-- /commentAccordionPanel -->

    </div> <!-- /col-12 -->
  </div> <!-- /row -->
</div>

<!-- ì˜¤ë¥˜ ì•Œë¦¼ ì‹œìŠ¤í…œ JS -->
<script th:src="@{/js/error-notification.js}"></script>

<script th:inline="javascript">
  /**
   * í˜ì´ì§€ ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
   */
  document.addEventListener('DOMContentLoaded', function() {
    // === ì•„ì½”ë””ì–¸ íŒ¨ë„ ì´ˆê¸° ìƒíƒœ ê°•ì œ ì„¤ì • ===
    const likePanel = document.getElementById('likeAccordionPanel');
    const commentPanel = document.getElementById('commentAccordionPanel');
    const likeHeader = document.getElementById('likeAccordionHeader');
    const commentHeader = document.getElementById('commentAccordionHeader');

    // ì¢‹ì•„ìš” íŒ¨ë„: ë‹«í˜ ìƒíƒœ ê°•ì œ ì„¤ì •
    if (likePanel) {
      likePanel.classList.remove('show');
      likePanel.style.height = '';
    }

    // ë‹µë³€ íŒ¨ë„: ì—´ë¦¼ ìƒíƒœ ìœ ì§€ (show í´ë˜ìŠ¤ëŠ” HTMLì— ìˆìŒ)
    // (ë³„ë„ ì¡°ì‘ ë¶ˆí•„ìš”)

    // í™”ì‚´í‘œ ì´ˆê¸° ë°©í–¥ ê°•ì œ ì„¤ì •
    // ì¢‹ì•„ìš”: ë‹«í˜ â†’ ìœ„ ë°©í–¥ (180deg)
    // ë‹µë³€: ì—´ë¦¼ â†’ ì•„ë˜ ë°©í–¥ (0deg)
    if (likeHeader) {
      const likeIcon = likeHeader.querySelector('.accordion-toggle-icon i');
      if (likeIcon) {
        likeIcon.style.transform = 'rotate(180deg)'; // ìœ„ ë°©í–¥
      }
    }
    if (commentHeader) {
      const commentIcon = commentHeader.querySelector('.accordion-toggle-icon i');
      if (commentIcon) {
        commentIcon.style.transform = 'rotate(0deg)'; // ì•„ë˜ ë°©í–¥
      }
    }

    // ë‹µê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„ (ì¶”ê°€ í•„ìš”)
    document.addEventListener('click', function(e) {
      if (e.target.closest('.reply-btn')) {
        const btn = e.target.closest('.reply-btn');
        const commentId = btn.getAttribute('data-comment-id');
        const authorName = btn.getAttribute('data-author-name');
        setReplyTo(commentId, authorName);
        const modal = new bootstrap.Modal(document.getElementById('commentWriteModal'));
        modal.show();
      }

      // ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼
      if (e.target.closest('.delete-comment-btn')) {
        openDeleteCommentModal(e.target.closest('.delete-comment-btn'));
      }
    });

    // ëŒ“ê¸€ ì‘ì„± ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ í¬ì»¤ìŠ¤
    const commentModal = document.getElementById('commentWriteModal');
    if (commentModal) {
      commentModal.addEventListener('show.bs.modal', function() {
        setTimeout(() => { document.getElementById('commentContent').focus(); }, 100);
      });
    }

    // ëŒ“ê¸€ ì‘ì„± ëª¨ë‹¬ì´ ë‹«í ë•Œ ì´ˆê¸°í™” (ì¶”ê°€ ê¶Œì¥)
    const openCommentModalBtn = document.getElementById('openCommentModalBtn');
    if (openCommentModalBtn) {
      openCommentModalBtn.addEventListener('click', function(e) {
        e.preventDefault();
        resetCommentModal();
      });
    }
  });

  /**
   * ì¢‹ì•„ìš” í† ê¸€ (AJAX)
   * - ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê°€ëŠ¥
   * - í•˜íŠ¸ ì•„ì´ì½˜ ë° ê°œìˆ˜ ì—…ë°ì´íŠ¸
   * - ì•„ì½”ë””ì–¸ í¼ì¹¨/ì ‘í˜ê³¼ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘
   */
  function toggleLike(event) {
    // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ (ì•„ì½”ë””ì–¸ í† ê¸€ê³¼ ë…ë¦½)
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    const postId = /*[[${post.id}]]*/ '';
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch('/photo/detail/' + postId + '/like', {
      method: 'POST',
      headers: {
        [csrfHeader]: csrfToken,
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // íƒ­ì˜ í•˜íŠ¸ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
        const likeIcon = document.getElementById('likeIcon');
        if (data.liked) {
          // ì¢‹ì•„ìš” ì¶”ê°€ë¨ (ë¹¨ê°„ í•˜íŠ¸)
          likeIcon.className = 'fa fa-heart text-danger';
        } else {
          // ì¢‹ì•„ìš” ì·¨ì†Œë¨ (ë¹ˆ í•˜íŠ¸)
          likeIcon.className = 'fa fa-heart-o';
        }

        // ì¢‹ì•„ìš” ê°œìˆ˜ ì—…ë°ì´íŠ¸
        document.getElementById('likeCountTab').textContent = data.likeCount;

        // 3. [í•µì‹¬] ì‚¬ìš©ì ëª©ë¡ UI ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        updateLikedUsersList(data.likedUsers);

        // Toast ì•Œë¦¼
        TOAST.showSuccess(data.message, 2000);
      } else {
        // ì—ëŸ¬ (ë¹„ë¡œê·¸ì¸ ë“±)
        TOAST.showError(data.error, 3000);
      }
    })
    .catch(error => {
      console.error('Like toggle error:', error);
      TOAST.showError('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 3000);
    });
  }

  /**
   * [ì¶”ê°€] ì¢‹ì•„ìš” ì‚¬ìš©ì ëª©ë¡ DOM ì¬êµ¬ì„± í•¨ìˆ˜
   * - ì„œë²„ì—ì„œ ë°›ì€ JSON ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ HTMLì„ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
   */
  function updateLikedUsersList(users) {
    const container = document.getElementById('likedUsersContainer');
    if (!container) return;

    // ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ 'ì•ˆë‚´ ë©”ì‹œì§€' ì¶œë ¥
    if (!users || users.length === 0) {
      container.innerHTML = `
        <div class="alert alert-light text-center">
          <i class="fa fa-heart-o me-2"></i>ì•„ì§ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      `;
      return;
    }

    // ëª©ë¡ì´ ìˆìœ¼ë©´ Grid ìƒì„±
    let html = `
      <h5 class="mb-3 fw-bold text-center">ğŸ“Œ ì´ ê¸€ì— ê³µê°í•œ ì‚¬ìš©ì</h5>
      <div class="row g-2">
    `;

    // ì‚¬ìš©ìë³„ HTML ì¡°ë¦½
    users.forEach(user => {
      // ì´ë¯¸ì§€/ì•„ë°”íƒ€ ë¶„ê¸° ì²˜ë¦¬
      let profileHtml = '';
      if (user.hasProfileImage) {
        profileHtml = `<div class="rounded-circle me-2 flex-shrink-0"
             style="width: 36px; height: 36px; background-image: url('${user.profileImageUrl}'); background-size: cover; background-position: center;">
        </div>`;
      } else {
        profileHtml = `<div class="rounded-circle me-2 flex-shrink-0 d-flex align-items-center justify-content-center text-white fw-bold"
             style="width: 36px; height: 36px; background-color: ${user.avatarColor}; font-size: 14px;">
             ${user.initial}
        </div>`;
      }

      html += `
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <div class="d-flex align-items-center p-2 border rounded bg-light">
            ${profileHtml}
            <span class="fw-bold text-truncate" title="${user.nickname}">${user.nickname}</span>
          </div>
        </div>
      `;
    });

    html += `</div>`; // row ë‹«ê¸°

    // ì»¨í…Œì´ë„ˆ ë‚´ìš© êµì²´
    container.innerHTML = html;
  }

  /**
   * ìƒí˜¸ ë°°íƒ€ì  ì•„ì½”ë””ì–¸ ë™ì‘ + í™”ì‚´í‘œ íšŒì „ ì• ë‹ˆë©”ì´ì…˜
   * - ì¢‹ì•„ìš” íŒ¨ë„ì„ ì—´ë©´ ë‹µë³€ íŒ¨ë„ì„ ë‹«ìŒ
   * - ë‹µë³€ íŒ¨ë„ì„ ì—´ë©´ ì¢‹ì•„ìš” íŒ¨ë„ì„ ë‹«ìŒ
   * - í™”ì‚´í‘œê°€ ìì—°ìŠ¤ëŸ½ê²Œ íšŒì „ (CSS transition í™œìš©)
   * - ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€ (í˜ì´ì§€ ì í”„ ë°©ì§€)
   */
  (function initAccordionBehavior() {
    const likePanel = document.getElementById('likeAccordionPanel');
    const likeHeader = document.getElementById('likeAccordionHeader');
    const likeToggleIcon = likeHeader.querySelector('.accordion-toggle-icon i');

    const commentPanel = document.getElementById('commentAccordionPanel');
    const commentHeader = document.getElementById('commentAccordionHeader');
    const commentToggleIcon = commentHeader.querySelector('.accordion-toggle-icon i');

    // === í—¤ë” í´ë¦­ ì‹œ ìŠ¤í¬ë¡¤ ë°©ì§€ + ìˆ˜ë™ í† ê¸€ ===
    likeHeader.addEventListener('click', function(e) {
      e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ìŠ¤í¬ë¡¤ ì í”„ ë°©ì§€)
      const likeCollapse = bootstrap.Collapse.getOrCreateInstance(likePanel);
      likeCollapse.toggle(); // ìˆ˜ë™ í† ê¸€
    });

    commentHeader.addEventListener('click', function(e) {
      e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ìŠ¤í¬ë¡¤ ì í”„ ë°©ì§€)
      const commentCollapse = bootstrap.Collapse.getOrCreateInstance(commentPanel);
      commentCollapse.toggle(); // ìˆ˜ë™ í† ê¸€
    });

    // === ì¢‹ì•„ìš” íŒ¨ë„ ì´ë²¤íŠ¸ ===
    likePanel.addEventListener('show.bs.collapse', function() {
      // ì¢‹ì•„ìš” íŒ¨ë„ ì—´ê¸° â†’ í™”ì‚´í‘œ ì•„ë˜ ë°©í–¥ (0deg)
      if (likeToggleIcon) {
        likeToggleIcon.style.transform = 'rotate(0deg)';
      }

      // ë‹µë³€ íŒ¨ë„ ë‹«ê¸° (ë‹¤ë¥¸ íŒ¨ë„ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ)
      if (commentPanel.classList.contains('show')) {
        const commentCollapse = bootstrap.Collapse.getOrCreateInstance(commentPanel);
        commentCollapse.hide();
      }
    });

    likePanel.addEventListener('hide.bs.collapse', function() {
      // ì¢‹ì•„ìš” íŒ¨ë„ ë‹«ê¸° â†’ í™”ì‚´í‘œ ìœ„ ë°©í–¥ (180deg)
      if (likeToggleIcon) {
        likeToggleIcon.style.transform = 'rotate(180deg)';
      }
      // ë‹¤ë¥¸ íŒ¨ë„ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ (ê·¸ëŒ€ë¡œ ìœ ì§€)
    });

    // === ë‹µë³€ íŒ¨ë„ ì´ë²¤íŠ¸ ===
    commentPanel.addEventListener('show.bs.collapse', function() {
      // ë‹µë³€ íŒ¨ë„ ì—´ê¸° â†’ í™”ì‚´í‘œ ì•„ë˜ ë°©í–¥ (0deg)
      if (commentToggleIcon) {
        commentToggleIcon.style.transform = 'rotate(0deg)';
      }

      // ì¢‹ì•„ìš” íŒ¨ë„ ë‹«ê¸° (ë‹¤ë¥¸ íŒ¨ë„ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ)
      if (likePanel.classList.contains('show')) {
        const likeCollapse = bootstrap.Collapse.getOrCreateInstance(likePanel);
        likeCollapse.hide();
      }
    });

    commentPanel.addEventListener('hide.bs.collapse', function() {
      // ë‹µë³€ íŒ¨ë„ ë‹«ê¸° â†’ í™”ì‚´í‘œ ìœ„ ë°©í–¥ (180deg)
      if (commentToggleIcon) {
        commentToggleIcon.style.transform = 'rotate(180deg)';
      }
      // ë‹¤ë¥¸ íŒ¨ë„ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ (ê·¸ëŒ€ë¡œ ìœ ì§€)
    });

    // === í—¤ë” í˜¸ë²„ íš¨ê³¼ ===
    [likeHeader, commentHeader].forEach(header => {
      header.addEventListener('mouseenter', function() {
        this.style.backgroundColor = '#e9ecef';
      });
      header.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '#f8f9fa';
      });
    });
  })();

  /**
   * [ì¶”ê°€] ëŒ“ê¸€ ì‘ì„± í¼ ì œì¶œ ì²˜ë¦¬ (AJAX)
   * - HTMLì˜ onsubmit="submitCommentAjax(event)"ì— ì˜í•´ í˜¸ì¶œë¨
   */
  function submitCommentAjax(event) {
    // 1. í¼ì˜ ê¸°ë³¸ ì œì¶œ ë™ì‘(ìƒˆë¡œê³ ì¹¨) ì°¨ë‹¨
    event.preventDefault();

    const form = document.getElementById('commentForm');

    // ìœ íš¨ì„± ê²€ì‚¬
    const authorName = document.getElementById('commentAuthor').value.trim();
    const content = document.getElementById('commentContent').value.trim();

    if (!authorName) {
      TOAST.showError('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 3000);
      return;
    }
    if (!content) {
      TOAST.showError('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 3000);
      return;
    }

    const postId = /*[[${post.id}]]*/ '';
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    const formData = new FormData(form);
    const submitBtn = document.getElementById('submitCommentBtn');

    // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ë“±ë¡ ì¤‘...';

    // AJAX ìš”ì²­ (POST)
    fetch('/photo/detail/' + postId + '/comments', {
      method: 'POST',
      headers: {
        [csrfHeader]: csrfToken
      },
      body: formData
    })
      .then(response => {
        if (!response.ok) return response.text().then(text => Promise.reject(text));
        return response.text();
      })
      .then(() => {
        // ì„±ê³µ ì‹œ ì²˜ë¦¬
        const modalEl = document.getElementById('commentWriteModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        resetCommentModal();
        form.reset();
        TOAST.showSuccess('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 2000);

        // ëª©ë¡ ê°±ì‹ ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨
        setTimeout(() => { window.location.reload(); }, 500);
      })
      .catch(error => {
        console.error(error);
        TOAST.showError('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ' + error, 3000);
      })
      .finally(() => {
        // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ë“±ë¡';
      });
  }

  /**
   * ëŒ“ê¸€ ì‚­ì œ ëª¨ë‹¬ ì—´ê¸°
   * - ë¹„ë°€ë²ˆí˜¸ ì„¤ì •ëœ ëŒ“ê¸€ì€ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ í‘œì‹œ
   */
  function openDeleteCommentModal(button) {
    const commentId = button.getAttribute('data-comment-id');
    const hasPassword = button.getAttribute('data-has-password') === 'true';
    const postId = /*[[${post.id}]]*/ '';

    const form = document.getElementById('deleteCommentForm');
    form.action = '/photo/detail/' + postId + '/comments/' + commentId + '/delete';

    const passwordGroup = document.getElementById('commentPasswordGroup');
    const passwordInput = document.getElementById('commentDeletePassword');

    if (hasPassword) {
      passwordGroup.style.display = 'block';
      passwordInput.required = true;
    } else {
      passwordGroup.style.display = 'none';
      passwordInput.required = false;
    }

    const modal = new bootstrap.Modal(document.getElementById('deleteCommentModal'));
    modal.show();
  }

  // [ê¸°ì¡´ í•¨ìˆ˜ë“¤] ë‹µê¸€ ì„¤ì • ë° ëª¨ë‹¬ ì´ˆê¸°í™” í•¨ìˆ˜ (í•„ìš”í•œ ê²½ìš° ìœ ì§€/ì¶”ê°€)
  function setReplyTo(parentId, parentAuthor) {
    document.getElementById('parentId').value = parentId;
    document.getElementById('replyToName').textContent = parentAuthor;
    document.getElementById('replyToInfo').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'ë‹µê¸€ ì‘ì„±';
  }

  function resetCommentModal() {
    document.getElementById('parentId').value = '';
    document.getElementById('replyToInfo').style.display = 'none';
    document.getElementById('modalTitle').textContent = 'ëŒ“ê¸€ ì‘ì„±';
    document.getElementById('commentContent').value = '';
  }

  /**
   * [ì¶”ê°€] ëŒ“ê¸€ ì‚­ì œ AJAX ì²˜ë¦¬
   * - ì‚­ì œ í›„ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ë¹„ë™ê¸° í†µì‹  ì‚¬ìš©
   */
  function deleteCommentAjax(event) {
    // 1. í¼ ê¸°ë³¸ ì œì¶œ(í˜ì´ì§€ ì´ë™) ë§‰ê¸°
    event.preventDefault();

    const form = document.getElementById('deleteCommentForm');
    const passwordInput = document.getElementById('commentDeletePassword');

    // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ë° ë¹„ì–´ìˆë‹¤ë©´ ê²½ê³ 
    if (document.getElementById('commentPasswordGroup').style.display !== 'none') {
      if (!passwordInput.value.trim()) {
        TOAST.showError('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 3000);
        return;
      }
    }

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    // form.actionì— ì´ë¯¸ ì‚­ì œ URLì´ ì„¤ì •ë˜ì–´ ìˆìŒ (openDeleteCommentModal í•¨ìˆ˜ì—ì„œ ì„¤ì •)
    const deleteUrl = form.action;
    const formData = new FormData(form);

    // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ì‚­ì œ ì¤‘...';

    fetch(deleteUrl, {
      method: 'POST',
      headers: {
        [csrfHeader]: csrfToken
      },
      body: formData
    })
      .then(response => {
        // ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‘ë‹µì´ ì˜¤ë”ë¼ë„ AJAXëŠ” fetchê°€ ì²˜ë¦¬í•¨
        // ì„œë²„ê°€ "redirect:..."ë¥¼ ë°˜í™˜í•´ë„ fetch ì…ì¥ì—ì„œëŠ” 200 OKì¼ ìˆ˜ ìˆìŒ (í˜ì´ì§€ HTMLì„ ë°˜í™˜ë°›ìŒ)
        if (response.ok) {
          return response.text();
        } else {
          return response.text().then(text => Promise.reject(text));
        }
      })
      .then(() => {
        // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
        const modalEl = document.getElementById('deleteCommentModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        form.reset();
        TOAST.showSuccess('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 2000);

        // [í•µì‹¬] ìŠ¤í¬ë¡¤ ìœ ì§€ë¥¼ ìœ„í•´ JSë¡œ ìƒˆë¡œê³ ì¹¨
        setTimeout(() => { window.location.reload(); }, 500);
      })
      .catch(error => {
        console.error('Delete failed:', error);
        // ì„œë²„ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ HTML ì „ì²´ë¡œ ì¤„ ìˆ˜ë„ ìˆì–´ì„œ, ê°„ë‹¨íˆ ì²˜ë¦¬
        TOAST.showError('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 3000);
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      });
  }

</script>

<!-- ì‚­ì œ ëª¨ë‹¬ -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ê²Œì‹œê¸€ ì‚­ì œ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form th:action="@{/photo/delete/{id}(id=${post.id})}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="modal-body">
          <p>ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="custom-btn custom-btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="submit" class="custom-btn custom-btn-danger">ì‚­ì œ</button>
        </div>
      </form>
    </div>
  </div>
</div>
</div> <!-- /wrapper div -->

