<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>
<div class="container mt-5">
  <div class="row">
    <div class="col-12">
      <!-- 헤더: 제목 + 홈 버튼 -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
          <i class="bi bi-gear"></i> 시스템 설정 관리
          <span class="badge bg-danger ms-2">관리자 전용</span>
        </h2>
        <a th:href="@{/}" class="btn btn-secondary" style="min-width: 120px; height: 42px;">
          <i class="bi bi-house"></i> 홈으로
        </a>
      </div>

      <!-- Flash 메시지 (hidden, modal로 표시) -->
      <div th:if="${message}" style="display: none;" id="flashMessage" th:attr="data-message=${message}"></div>
      <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <!-- 설정 안내 -->
      <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i>
        <strong>설정 관리 안내</strong>
        <p class="mb-0 mt-2">
          시스템 설정을 변경하면 즉시 적용됩니다. 신중하게 설정해주세요.
        </p>
      </div>

      <!-- 설정 목록 -->
      <div class="row">
        <div class="col-md-8">
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-sliders"></i> 시스템 설정 목록
              </h5>
              <button type="button"
                      class="btn btn-sm btn-light"
                      data-bs-toggle="modal"
                      data-bs-target="#detailModal"
                      title="상세 보기">
                <i class="bi bi-plus-lg"></i> 상세
              </button>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="sticky-top bg-white">
                    <tr>
                      <th style="width: 25%;">설정 키</th>
                      <th style="width: 20%;">현재 값</th>
                      <th style="width: 35%;">설명</th>
                      <th style="width: 20%;">액션</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="config : ${configs}">
                      <td>
                        <strong th:text="${config.propertyKey}"></strong>
                      </td>
                      <td>
                        <!-- Boolean 값은 배지로 표시 -->
                        <span th:if="${config.propertyValue == 'true'}" class="badge bg-success">
                          <i class="bi bi-check-circle"></i> 활성화
                        </span>
                        <span th:if="${config.propertyValue == 'false'}" class="badge bg-secondary">
                          <i class="bi bi-x-circle"></i> 비활성화
                        </span>
                        <!-- 숫자 값은 그대로 표시 -->
                        <span th:if="${config.propertyValue != 'true' && config.propertyValue != 'false'}"
                              th:text="${config.propertyValue}"></span>
                      </td>
                      <td>
                        <small th:text="${config.description}"></small>
                      </td>
                      <td>
                        <!-- Boolean 값: 활성화 → 비활성화 버튼, 비활성화 → 활성화 버튼 -->
                        <button th:if="${config.propertyValue == 'true'}"
                                type="button"
                                class="btn btn-sm btn-warning"
                                style="min-width: 90px;"
                                th:attr="data-key=${config.propertyKey},
                                         data-value=${config.propertyValue},
                                         data-description=${config.description}"
                                onclick="openToggleModal(this, 'false')">
                          <i class="bi bi-x-circle"></i> 비활성화
                        </button>
                        <button th:if="${config.propertyValue == 'false'}"
                                type="button"
                                class="btn btn-sm btn-success"
                                style="min-width: 90px;"
                                th:attr="data-key=${config.propertyKey},
                                         data-value=${config.propertyValue},
                                         data-description=${config.description}"
                                onclick="openToggleModal(this, 'true')">
                          <i class="bi bi-check-circle"></i> 활성화
                        </button>
                        <!-- 숫자 값: 수정 버튼 -->
                        <button th:if="${config.propertyValue != 'true' && config.propertyValue != 'false'}"
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                style="min-width: 90px;"
                                data-bs-toggle="modal"
                                data-bs-target="#editModal"
                                th:attr="data-key=${config.propertyKey},
                                         data-value=${config.propertyValue},
                                         data-description=${config.description}"
                                onclick="openEditModal(this)">
                          <i class="bi bi-pencil"></i> 수정
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 현재 상태 패널 -->
        <div class="col-md-4">
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-info-circle"></i> 현재 상태
              </h5>
              <button type="button"
                      class="btn btn-sm btn-light"
                      data-bs-toggle="modal"
                      data-bs-target="#statusModal"
                      title="상세 보기">
                <i class="bi bi-plus-lg"></i> 상세
              </button>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center" th:each="config : ${configs}">
                  <strong th:text="${config.propertyKey}"></strong>
                  <div>
                    <span th:if="${config.propertyValue == 'true'}" class="badge bg-success">활성화</span>
                    <span th:if="${config.propertyValue == 'false'}" class="badge bg-secondary">비활성화</span>
                    <span th:if="${config.propertyValue != 'true' && config.propertyValue != 'false'}"
                          class="badge bg-primary" th:text="${config.propertyValue}"></span>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 토글 경고 모달 -->
<div class="modal fade" id="toggleModal" tabindex="-1" aria-labelledby="toggleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="toggleModalLabel">
          <i class="bi bi-exclamation-triangle"></i> 설정 변경 확인
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning" role="alert">
          <i class="bi bi-exclamation-triangle-fill"></i>
          <strong>경고:</strong> 시스템 설정을 변경하시겠습니까?
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label"><strong>설정 키</strong></label>
            <p id="toggleKey" class="form-control-plaintext"></p>
          </div>
          <div class="col-md-6">
            <label class="form-label"><strong>설명</strong></label>
            <p id="toggleDescription" class="form-control-plaintext small"></p>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label"><strong>현재 상태</strong></label>
            <p id="toggleCurrentValue" class="form-control-plaintext"></p>
          </div>
          <div class="col-md-6">
            <label class="form-label"><strong>변경 후 상태</strong></label>
            <p id="toggleNewValue" class="form-control-plaintext"></p>
          </div>
        </div>

        <!-- 주의사항 영역 -->
        <div class="card bg-light" id="toggleWarningCard" style="display: none;">
          <div class="card-header bg-danger text-white">
            <h6 class="mb-0">
              <i class="bi bi-exclamation-octagon"></i> 주의사항
            </h6>
          </div>
          <div class="card-body" id="toggleWarning">
            <!-- JavaScript로 동적 생성 -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" style="min-width: 120px; height: 42px;" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> No (취소)
        </button>
        <button type="button" class="btn btn-primary" style="min-width: 120px; height: 42px;" onclick="submitToggle()">
          <i class="bi bi-check-circle"></i> Yes (변경)
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 시스템 설정 목록 상세 보기 모달 -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="detailModalLabel">
          <i class="bi bi-list-ul"></i> 시스템 설정 목록 상세
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
        <table class="table table-bordered table-hover">
          <thead class="table-primary sticky-top">
            <tr>
              <th style="width: 25%;">설정 키</th>
              <th style="width: 15%;">현재 값</th>
              <th style="width: 40%;">설명</th>
              <th style="width: 20%;">액션</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="config : ${configs}">
              <td><strong th:text="${config.propertyKey}"></strong></td>
              <td>
                <span th:if="${config.propertyValue == 'true'}" class="badge bg-success">활성화</span>
                <span th:if="${config.propertyValue == 'false'}" class="badge bg-secondary">비활성화</span>
                <span th:if="${config.propertyValue != 'true' && config.propertyValue != 'false'}"
                      th:text="${config.propertyValue}"></span>
              </td>
              <td><small th:text="${config.description}"></small></td>
              <td>
                <button th:if="${config.propertyValue == 'true'}"
                        type="button"
                        class="btn btn-sm btn-warning"
                        th:attr="data-key=${config.propertyKey},
                                 data-value=${config.propertyValue},
                                 data-description=${config.description}"
                        onclick="openToggleModal(this, 'false')">
                  비활성화
                </button>
                <button th:if="${config.propertyValue == 'false'}"
                        type="button"
                        class="btn btn-sm btn-success"
                        th:attr="data-key=${config.propertyKey},
                                 data-value=${config.propertyValue},
                                 data-description=${config.description}"
                        onclick="openToggleModal(this, 'true')">
                  활성화
                </button>
                <button th:if="${config.propertyValue != 'true' && config.propertyValue != 'false'}"
                        type="button"
                        class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#editModal"
                        th:attr="data-key=${config.propertyKey},
                                 data-value=${config.propertyValue},
                                 data-description=${config.description}"
                        onclick="openEditModal(this)">
                  수정
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" style="min-width: 120px; height: 42px;" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> 닫기
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 현재 상태 상세 보기 모달 -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="statusModalLabel">
          <i class="bi bi-info-circle"></i> 현재 상태 상세
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between align-items-start" th:each="config : ${configs}">
            <div class="ms-2 me-auto" style="flex: 1;">
              <div class="fw-bold" th:text="${config.propertyKey}"></div>
              <small class="text-muted" th:text="${config.description}"></small>
            </div>
            <span th:if="${config.propertyValue == 'true'}" class="badge bg-success rounded-pill">활성화</span>
            <span th:if="${config.propertyValue == 'false'}" class="badge bg-secondary rounded-pill">비활성화</span>
            <span th:if="${config.propertyValue != 'true' && config.propertyValue != 'false'}"
                  class="badge bg-primary rounded-pill" th:text="${config.propertyValue}"></span>
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" style="min-width: 120px; height: 42px;" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> 닫기
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 성공 모달 -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">
          <i class="bi bi-check-circle-fill"></i> 설정 변경 완료
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
        <h4 class="mt-3" id="successMessage"></h4>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-success" style="min-width: 120px; height: 42px;" data-bs-dismiss="modal">
          <i class="bi bi-check"></i> 확인
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 설정 수정 모달 (숫자 값 등) -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">
          <i class="bi bi-pencil-square"></i> 설정 수정
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form th:action="@{/admin/settings/update}" method="post" id="editForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editKey" class="form-label">설정 키</label>
            <input type="text"
                   id="editKey"
                   name="key"
                   class="form-control"
                   readonly>
          </div>
          <div class="mb-3">
            <label for="editValue" class="form-label">
              설정 값 <span class="text-danger">*</span>
            </label>
            <input type="text"
                   id="editValue"
                   name="value"
                   class="form-control"
                   required>
            <small class="form-text text-muted">
              숫자 값을 입력하세요.
            </small>
          </div>
          <div class="mb-3">
            <label class="form-label">설명</label>
            <p id="editDescription" class="form-control-plaintext"></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" style="min-width: 120px; height: 42px;" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> 취소
          </button>
          <button type="submit" class="btn btn-primary" style="min-width: 120px; height: 42px;">
            <i class="bi bi-save"></i> 저장
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let toggleKeyValue = '';
let toggleNewValueText = '';

/**
 * 주의사항 정의
 * - 각 설정 키별 주의사항을 미리 정의
 */
const warnings = {
  'multiLoginEnabled': {
    title: '멀티로그인 설정 주의사항',
    content: `
      <ul class="mb-0">
        <li><strong>활성화 시:</strong> 동일 계정으로 최대 5개 기기에서 동시 로그인 가능</li>
        <li><strong>예시:</strong> PC 2대 + 모바일 3대 = 총 5개 기기</li>
        <li><strong>초과 시:</strong> 6번째 기기에서 로그인 시 가장 오래된 세션이 자동으로 종료됩니다</li>
        <li><strong>비활성화 시:</strong> 단일 로그인만 허용 (새 로그인 시 기존 세션 종료)</li>
      </ul>
    `
  },
  'fileUploadEnabled': {
    title: '파일 업로드 설정 주의사항',
    content: `
      <ul class="mb-0">
        <li><strong>활성화 시:</strong> 게시글 작성 시 파일 첨부 기능 사용 가능</li>
        <li><strong>비활성화 시:</strong> 파일 첨부 버튼이 숨겨지며 업로드 불가능</li>
        <li><strong>주의:</strong> 비활성화 시 기존에 업로드된 파일은 유지되나 다운로드만 가능</li>
      </ul>
    `
  }
};

/**
 * 토글 경고 모달 열기
 * - 버튼 클릭 시 경고 모달 표시 + 주의사항 표출
 */
function openToggleModal(element, newValue) {
  const key = element.getAttribute('data-key');
  const currentValue = element.getAttribute('data-value');
  const description = element.getAttribute('data-description');

  // 표시 텍스트
  const currentText = currentValue === 'true' ? '활성화' : '비활성화';
  const newText = newValue === 'true' ? '활성화' : '비활성화';

  // 모달 내용 설정
  document.getElementById('toggleKey').textContent = key;
  document.getElementById('toggleCurrentValue').innerHTML =
    `<span class="badge ${currentValue === 'true' ? 'bg-success' : 'bg-secondary'}">${currentText}</span>`;
  document.getElementById('toggleNewValue').innerHTML =
    `<span class="badge ${newValue === 'true' ? 'bg-success' : 'bg-secondary'}">${newText}</span>`;
  document.getElementById('toggleDescription').textContent = description;

  // 주의사항 표시
  const warningCard = document.getElementById('toggleWarningCard');
  const warningContent = document.getElementById('toggleWarning');

  if (warnings[key]) {
    warningCard.style.display = 'block';
    warningContent.innerHTML = `
      <h6 class="text-danger">${warnings[key].title}</h6>
      ${warnings[key].content}
    `;
  } else {
    warningCard.style.display = 'none';
  }

  // 전역 변수에 저장
  toggleKeyValue = key;
  toggleNewValueText = newValue;

  // 토글 모달 표시
  const modal = new bootstrap.Modal(document.getElementById('toggleModal'));
  modal.show();
}

/**
 * 토글 값 제출
 * - Yes 클릭 시 폼 제출
 * - CSRF 토큰 포함
 */
function submitToggle() {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/admin/settings/update';

  const keyInput = document.createElement('input');
  keyInput.type = 'hidden';
  keyInput.name = 'key';
  keyInput.value = toggleKeyValue;

  const valueInput = document.createElement('input');
  valueInput.type = 'hidden';
  valueInput.name = 'value';
  valueInput.value = toggleNewValueText;

  // CSRF 토큰 추가
  const csrfToken = document.querySelector('meta[name="_csrf"]');
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]');

  if (csrfToken && csrfToken.content) {
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '_csrf';
    csrfInput.value = csrfToken.content;
    form.appendChild(csrfInput);
  }

  form.appendChild(keyInput);
  form.appendChild(valueInput);
  document.body.appendChild(form);
  form.submit();
}

/**
 * 설정 수정 모달 열기 (숫자 값 등)
 * - 설정 키, 값, 설명 표시
 */
function openEditModal(button) {
  const key = button.getAttribute('data-key');
  const value = button.getAttribute('data-value');
  const description = button.getAttribute('data-description');

  document.getElementById('editKey').value = key;
  document.getElementById('editValue').value = value;
  document.getElementById('editDescription').textContent = description;
}

/**
 * 페이지 로드 시 성공 메시지 모달 표시
 */
document.addEventListener('DOMContentLoaded', function() {
  const flashMessageEl = document.getElementById('flashMessage');
  if (flashMessageEl) {
    const message = flashMessageEl.getAttribute('data-message');
    if (message) {
      document.getElementById('successMessage').textContent = message;
      const successModal = new bootstrap.Modal(document.getElementById('successModal'));
      successModal.show();
    }
  }
});

/**
 * 시스템 설정 목록 상세 보기 모달 표시
 */
function showDetailModal() {
  const modal = new bootstrap.Modal(document.getElementById('detailModal'));
  modal.show();
}

/**
 * 현재 상태 상세 보기 모달 표시
 */
function showStatusModal() {
  const modal = new bootstrap.Modal(document.getElementById('statusModal'));
  modal.show();
}
</script>
</body>
</html>

