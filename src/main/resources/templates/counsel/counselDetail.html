<!-- ì˜¨ë¼ì¸ ìƒë‹´ ìƒì„¸ í…œí”Œë¦¿ (layout.htmlì— ì‚½ì…ë˜ëŠ” í”„ë˜ê·¸ë¨¼íŠ¸) -->
<div xmlns:th="http://www.thymeleaf.org">
<!-- ì•„ì½”ë””ì–¸ ì• ë‹ˆë©”ì´ì…˜ CSS -->
<style>
  /* ì•„ì½”ë””ì–¸ í—¤ë” */
  .accordion-header {
    user-select: none;
    border-radius: 0;
  }

  .accordion-header:hover {
    background-color: #e9ecef !important;
  }

  /* ì•„ì½”ë””ì–¸ í† ê¸€ ì•„ì´ì½˜ (í™”ì‚´í‘œ) íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
  .accordion-toggle-icon i {
    display: inline-block;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: rotate(180deg); /* ì´ˆê¸° ìƒíƒœ: í™”ì‚´í‘œ ìœ„ ë°©í–¥ (ë‹«í˜ ìƒíƒœ) */
  }

  /* ì•„ì½”ë””ì–¸ ë³¸ë¬¸ */
  .accordion-body {
    padding: 1.5rem;
  }

  /* íŒ¨ë„ ë†’ì´ ë³€ê²½ ì• ë‹ˆë©”ì´ì…˜ (ë¶€ë“œëŸ½ê²Œ) */
  .collapse {
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    /*overflow: hidden; !* ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ë‚´ìš© ìˆ¨ê¹€ *! ìƒë‹¨ë°” ë©”ë‰´ ë˜í•œ hiddenìœ¼ë¡œ ë°”ë€œ, ì¢‹ì•„ìš”/ëŒ“ê¸€ ìš”ì†Œì—ë„ ì ìš©ë˜ëŠ” ìŠ¤íƒ€ì¼ ì—†ëŠ” ê²ƒìœ¼ë¡œ ë³´ì•„ ì£¼ì„ì²˜ë¦¬ */
  }

  .collapse.show {
    overflow: visible; /* ì—´ë¦° í›„ ë‚´ìš© í‘œì‹œ */
  }

  /* ì•„ì½”ë””ì–¸ í—¤ë” í°íŠ¸ */
  .accordion-header .fw-bold {
    font-weight: 600;
    color: #212529;
  }

  /* ê°­ ìŠ¤íƒ€ì¼ */
  .accordion-header .gap-2 {
    gap: 0.75rem;
  }
</style>

<div class="container mt-4">
  <!-- Flash ë©”ì‹œì§€ í‘œì‹œ -->
  <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${message}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div class="container-fluid px-0">
    <!-- ë²„íŠ¼ ê·¸ë£¹ -->
    <div class="d-flex justify-content-between mb-3">
      <div class="d-flex" style="gap: 8px;" th:if="${ownerYN == true}">
        <!-- ìˆ˜ì • ë²„íŠ¼ -->
        <a th:href="@{/counsel/edit/{id}(id=${post.id})}" class="custom-btn custom-btn-warning">
          <i class="bi bi-pencil me-1"></i> ìˆ˜ì •
        </a>
        <!-- ì‚­ì œ ë²„íŠ¼ -->
        <button type="button" class="custom-btn custom-btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
          <i class="bi bi-trash me-1"></i> ì‚­ì œ
        </button>
      </div>
      <a th:href="@{/counsel/list}" class="custom-btn custom-btn-secondary">
        <i class="bi bi-list me-1"></i> ëª©ë¡
      </a>
    </div>

    <div class="row">
      <hr class="mt-md-2 border-2 opacity-25"/>
      <h1><span th:text="${post.title}"></span></h1>
      <hr class="mt-md-2 border-1 opacity-25"/>
      <div class="d-md-flex gap-4">
        <h3 class="mb-0">ì‘ì„±ì : <span class="opacity-75" th:text="${post.authorName}"></span></h3>
        <h3 class="mb-0">ì‘ì„±ì¼ : <span class="opacity-75" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></span></h3>
        <h3 class="mb-0">ì¡°íšŒ : <span class="opacity-75" th:text="${post.viewCount}"></span></h3>
      </div>
    </div>

    <!-- ê´€ë¦¬ì ì „ìš©: ìƒíƒœ ë³€ê²½ -->
    <div class="row mt-3" sec:authorize="hasRole('ADMIN')">
      <div class="col-12">
        <div class="card border-warning">
          <div class="card-body">
            <h5 class="card-title">
              <i class="bi bi-shield-check text-warning"></i> ê´€ë¦¬ì ê¸°ëŠ¥
            </h5>
            <form th:action="@{/counsel/detail/{id}/status(id=${post.id})}" method="post" class="d-flex align-items-center gap-2">
              <label for="statusSelect" class="form-label mb-0">ìƒíƒœ ë³€ê²½:</label>
              <select id="statusSelect" name="status" class="form-select" style="width: auto;">
                <option value="WAIT" th:selected="${post.status.name() == 'WAIT'}">ë‹µë³€ëŒ€ê¸°</option>
                <option value="COMPLETE" th:selected="${post.status.name() == 'COMPLETE'}">ë‹µë³€ì™„ë£Œ</option>
                <option value="END" th:selected="${post.status.name() == 'END'}">ìƒë‹´ì¢…ë£Œ</option>
              </select>
              <button type="submit" class="btn btn-warning btn-sm">
                <i class="bi bi-arrow-clockwise"></i> ë³€ê²½
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-md-2">
      <div class="table table-bordered">
        <div class="p-3" th:utext="${post.content}"></div>
      </div>
    </div>

    <!-- ì²¨ë¶€íŒŒì¼ í‘œì‹œ -->
    <div class="row mt-3" th:if="${post.attachments != null and !post.attachments.isEmpty()}">
      <div class="col-12">
        <h5><i class="bi bi-paperclip"></i> ì²¨ë¶€íŒŒì¼</h5>
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between align-items-center" th:each="file : ${post.attachments}">
            <a th:href="@{/counsel/download/{fileId}(fileId=${file.id})}" th:text="${file.originalFileName}"></a>
            <span class="badge bg-secondary rounded-pill" th:text="${#numbers.formatDecimal(file.fileSize / 1024, 1, 2)} + ' KB'"></span>
          </li>
        </ul>
      </div>
    </div>

    <!-- ì¢‹ì•„ìš”/ë‹µë³€ íƒ­ í—¤ë” + íŒ¨ë„ ì˜ì—­ -->
    <div class="row mt-5">
      <div class="col-12">
        <!-- íƒ­ í—¤ë” (ì½˜í…ì¸  í¬ê¸°ì— ë§ê²Œ ì™¼ìª½ ì •ë ¬) -->
        <div class="border rounded-top" id="tabContainer" style="background-color: #f8f9fa; display: inline-flex; position: relative; z-index: 1;">

          <!-- ì¢‹ì•„ìš” í—¤ë” -->
          <div class="accordion-header d-flex align-items-center p-3"
               id="likeAccordionHeader"
               style="cursor: pointer; transition: background-color 0.3s ease; min-width: 150px; border-right: 1px solid #dee2e6; gap: 8px;"
               aria-expanded="false" aria-controls="likeAccordionPanel">

            <!-- ì¢‹ì•„ìš” í•˜íŠ¸ ì•„ì´ì½˜ (í´ë¦­ ì‹œ í† ê¸€) -->
            <span id="likeButton" style="cursor: pointer; font-size: 1.2rem;"
                  onclick="toggleLike(event)"
                  title="ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”">
              <i id="likeIcon" th:class="${isLiked} ? 'fa fa-heart text-danger' : 'fa fa-heart-o'"></i>
            </span>

            <!-- í…ìŠ¤íŠ¸ -->
            <span class="fw-bold">ì¢‹ì•„ìš” (<span id="likeCountTab" th:text="${likeCount}">0</span>)</span>

            <!-- ì•„ì½”ë””ì–¸ í™”ì‚´í‘œ (ì˜¤ë¥¸ìª½ ë) -->
            <span class="accordion-toggle-icon" style="display: inline-flex; align-items: center; transition: transform 0.3s ease; margin-left: auto;">
              <i class="fa fa-chevron-down"></i>
            </span>
          </div>

          <!-- ë‹µë³€ í—¤ë” -->
          <div class="accordion-header d-flex align-items-center p-3"
               id="commentAccordionHeader"
               style="cursor: pointer; transition: background-color 0.3s ease; min-width: 150px; gap: 8px;"
               aria-expanded="true" aria-controls="commentAccordionPanel">

            <!-- ì±„íŒ… ì•„ì´ì½˜ -->
            <i class="bi bi-chat-dots"></i>

            <!-- í…ìŠ¤íŠ¸ -->
            <span class="fw-bold">ë‹µë³€ (<span th:text="${#lists.size(comments)}">0</span>)</span>

            <!-- ì•„ì½”ë””ì–¸ í™”ì‚´í‘œ (ì˜¤ë¥¸ìª½ ë) -->
            <span class="accordion-toggle-icon" style="display: inline-flex; align-items: center; transition: transform 0.3s ease; margin-left: auto;">
              <i class="fa fa-chevron-down"></i>
            </span>
          </div>
        </div>

        <!-- ì¢‹ì•„ìš” íŒ¨ë„ -->
        <div class="collapse border border-top-0 rounded-bottom" id="likeAccordionPanel"
             style="transition: max-height 0.3s ease;">
          <div class="accordion-body p-4 bg-light">
                <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ì•ˆë‚´ -->
                <div sec:authorize="!isAuthenticated()" class="alert alert-info text-center mb-4">
                  <i class="fa fa-info-circle me-2"></i>ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
                </div>

                <!-- ì¢‹ì•„ìš” ëˆ„ë¥¸ ì‚¬ìš©ì ëª©ë¡ -->
                <div th:if="${likedUsers != null and !likedUsers.isEmpty()}">
                  <h5 class="mb-3 fw-bold text-center">ğŸ“Œ ì´ ê¸€ì— ê³µê°í•œ ì‚¬ìš©ì</h5>
                  <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                    <!-- ì‚¬ìš©ì ëª©ë¡ -->
                    <div th:each="user : ${likedUsers}" style="flex: 0 1 auto;">
                      <div class="d-flex align-items-center p-2 border rounded bg-white">
                        <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ë˜ëŠ” ì´ë‹ˆì…œ ì•„ë°”íƒ€ -->
                        <div th:if="${user.hasProfileImage()}"
                             class="rounded-circle me-2 flex-shrink-0"
                             th:style="'width: 36px; height: 36px; background-image: url(' + ${user.profileImageUrl} + '); background-size: cover; background-position: center;'">
                        </div>
                        <div th:unless="${user.hasProfileImage()}"
                             class="rounded-circle me-2 flex-shrink-0 d-flex align-items-center justify-content-center text-white fw-bold"
                             th:style="'width: 36px; height: 36px; background-color: ' + ${user.avatarColor} + '; font-size: 14px;'"
                             th:text="${user.initial}">
                        </div>
                        <!-- ë‹‰ë„¤ì„ -->
                        <span class="fw-bold text-truncate" th:text="${user.nickname}" th:title="${user.nickname}">ì‚¬ìš©ì</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ì¢‹ì•„ìš” ì—†ì„ ë•Œ ì•ˆë‚´ -->
                <div th:if="${likedUsers == null or likedUsers.isEmpty()}" class="alert alert-light text-center">
                  <i class="fa fa-heart-o me-2"></i>ì•„ì§ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
          </div> <!-- /accordion-body -->
        </div> <!-- /likeAccordionPanel -->

        <!-- ë‹µë³€ íŒ¨ë„ (ì´ˆê¸° ìƒíƒœ: ì—´ë¦¼) -->
        <div class="collapse show border border-top-0 rounded-bottom" id="commentAccordionPanel"
             style="transition: max-height 0.3s ease;">
          <div class="accordion-body p-4">

              <!-- ëŒ“ê¸€ ëª©ë¡ -->
              <div id="commentsContainer">
                <!-- ëŒ“ê¸€ ì—†ìŒ -->
                <div th:if="${#lists.isEmpty(comments)}" class="alert alert-light text-center py-5">
                  <i class="bi bi-chat-text fs-1 text-muted"></i>
                  <p class="mt-3 mb-0 text-muted">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                </div>

                <!-- ëŒ“ê¸€ ìˆì„ ë•Œë§Œ ë Œë”ë§ -->
                <div th:if="${!#lists.isEmpty(comments)}">
                  <div class="comments-container">
                    <!-- ì¬ê·€ ë Œë”ë§ ì‹œì‘ (Serviceì—ì„œ ì´ë¯¸ íŠ¸ë¦¬ êµ¬ì¡°ë¡œ ì •ë ¬ë¨) -->
                    <th:block th:each="comment : ${comments}">
                      <th:block th:replace="~{:: renderComment(${comment})}"></th:block>
                    </th:block>
                  </div>
                </div>
              </div>

              <!-- ëŒ“ê¸€ ì‘ì„± ë²„íŠ¼ (í•­ìƒ í‘œì‹œ, í•˜ë‹¨ ìš°ì¸¡) -->
              <div class="d-flex justify-content-end mt-4">
                <button type="button"
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#commentWriteModal"
                        id="openCommentModalBtn">
                  <i class="bi bi-pencil-square"></i> ëŒ“ê¸€ ì‘ì„±
                </button>
              </div>

          </div> <!-- /accordion-body -->
        </div> <!-- /commentAccordionPanel -->

      </div> <!-- /col-12 -->
    </div> <!-- /row -->

    <!-- ë‹¨ì¼ ëŒ“ê¸€ ë Œë”ë§ í”„ë˜ê·¸ë¨¼íŠ¸ (col-12 ë°–, ì¤‘ë³µ ë°©ì§€) -->
    <th:block th:fragment="renderComment(c)">
      <div th:if="${c != null}">
            <!-- ëŒ“ê¸€ ì¹´ë“œ (depthì— ë”°ë¼ ë“¤ì—¬ì“°ê¸°) -->
            <div class="comment-item mb-2"
                 th:style="${(c.depth != null && c.depth > 0) ? 'margin-left: ' + (c.depth * 48) + 'px; padding-left: 20px; border-left: 3px solid #e3f2fd;' : ''}">

              <!-- ë‹µê¸€ ëŒ€ìƒ í‘œì‹œ (ëŒ€ëŒ“ê¸€ì¸ ê²½ìš°) -->
              <div th:if="${c.depth != null && c.depth > 0 && c.parentAuthorName != null}"
                   class="reply-target-info mb-1"
                   style="font-size: 0.75rem; color: #0d6efd; font-weight: 500;">
                <i class="bi bi-arrow-return-right me-1"></i>
                <span th:text="'@' + ${c.parentAuthorName} + 'ë‹˜ì—ê²Œ ë‹µê¸€'">@ì‘ì„±ìë‹˜ì—ê²Œ ë‹µê¸€</span>
              </div>

              <!-- ëŒ“ê¸€ ì¹´ë“œ -->
              <div class="card shadow-sm border-0"
                   th:style="${c.staffReply ? 'border-left: 3px solid #198754 !important; border-radius: 6px; background-color: #f0fdf4;' : ((c.depth != null && c.depth > 0) ? 'border-radius: 6px; background-color: #f8f9fa;' : 'border-radius: 6px;')}">
                <div class="card-body p-2 p-md-3">
                  <!-- ëŒ“ê¸€ í—¤ë” -->
                  <div class="d-flex align-items-start mb-2">
                    <!-- ì•„ë°”íƒ€ -->
                    <div class="flex-shrink-0">
                      <div class="avatar-circle text-white d-flex align-items-center justify-content-center"
                           th:classappend="${(c.depth != null && c.depth > 0) ? 'bg-info' : 'bg-primary'}"
                           th:style="${(c.depth != null && c.depth > 0) ? 'width: 32px; height: 32px; font-size: 13px;' : 'width: 36px; height: 36px; font-size: 16px;'} + 'border-radius: 50%; font-weight: bold;'">
                        <span th:text="${#strings.substring(c.authorName, 0, 1)}">ì‘</span>
                      </div>
                    </div>

                    <!-- ì‘ì„±ì ì •ë³´ -->
                    <div class="flex-grow-1 ms-2">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <strong th:style="${(c.depth != null && c.depth > 0) ? 'font-size: 0.85rem;' : 'font-size: 0.95rem;'}"
                                  th:text="${c.authorName}">ì‘ì„±ì</strong>

                          <!-- ë‹µê¸€ ë°°ì§€ (ëŒ€ëŒ“ê¸€ì¸ ê²½ìš°) -->
                          <span th:if="${c.depth != null && c.depth > 0}" class="badge bg-info ms-1" style="font-size: 0.65rem;">
                            <i class="bi bi-reply-fill"></i> ë‹µê¸€
                          </span>

                          <!-- ìš´ì˜ì ë°°ì§€ -->
                          <span th:if="${c.staffReply}" class="badge bg-success ms-1"
                                th:style="${(c.depth != null && c.depth > 0) ? 'font-size: 0.65rem;' : 'font-size: 0.7rem;'}">
                            <i class="bi bi-shield-check"></i> ìš´ì˜ì
                          </span>
                        </div>

                        <!-- ì‘ì„± ì‹œê°„ -->
                        <small class="text-muted" th:style="${(c.depth != null && c.depth > 0) ? 'font-size: 0.75rem;' : 'font-size: 0.8rem;'}">
                          <i class="bi bi-clock"></i>
                          <span th:text="${#temporals.format(c.createdAt, 'MM-dd HH:mm')}"></span>
                        </small>
                      </div>
                    </div>
                  </div>

                  <!-- ëŒ“ê¸€ ë‚´ìš© -->
                  <div class="comment-content ps-0 ps-md-5 mb-2"
                       th:text="${c.content}"
                       th:style="${(c.depth != null && c.depth > 0) ? 'font-size: 0.85rem; line-height: 1.4; color: #555;' : 'font-size: 0.9rem; line-height: 1.5; color: #333;'} + 'word-break: break-word; white-space: pre-wrap;'"></div>

                  <!-- ëŒ“ê¸€ ì•¡ì…˜ ë²„íŠ¼ -->
                  <div class="d-flex justify-content-end ps-0 ps-md-5 gap-1">
                    <!-- ë‹µê¸€ ë²„íŠ¼ -->
                    <button type="button"
                            class="btn btn-sm btn-outline-primary reply-btn"
                            th:style="${(c.depth != null && c.depth > 0) ? 'font-size: 0.75rem; padding: 0.2rem 0.4rem;' : 'font-size: 0.8rem; padding: 0.25rem 0.5rem;'}"
                            data-bs-toggle="modal"
                            data-bs-target="#commentWriteModal"
                            th:attr="data-comment-id=${c.id},data-author-name=${c.authorName}">
                      <i class="bi bi-reply"></i> ë‹µê¸€
                    </button>

                    <!-- ì‚­ì œ ë²„íŠ¼ (ìš´ì˜ì ëŒ“ê¸€ ì œì™¸) -->
                    <button type="button"
                            class="btn btn-sm btn-outline-danger delete-comment-btn"
                            th:style="${(c.depth != null && c.depth > 0) ? 'font-size: 0.75rem; padding: 0.2rem 0.4rem;' : 'font-size: 0.8rem; padding: 0.25rem 0.5rem;'}"
                            th:if="${!c.staffReply}"
                            th:attr="data-comment-id=${c.id},data-has-password=${c.passwordHash != null}">
                      <i class="bi bi-trash"></i> ì‚­ì œ
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- ìì‹ ëŒ“ê¸€ ì¬ê·€ ë Œë”ë§ -->
            <th:block th:if="${!#lists.isEmpty(c.children)}">
              <th:block th:each="child : ${c.children}">
                <th:block th:replace="~{:: renderComment(${child})}"></th:block>
              </th:block>
            </th:block>
          </div>
    </th:block>

  </div> <!-- /container-fluid -->
</div> <!-- /container -->

<!-- ê²Œì‹œê¸€ ì‚­ì œ ëª¨ë‹¬ -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">ê²Œì‹œê¸€ ì‚­ì œ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form th:action="@{/counsel/delete/{id}(id=${post.id})}" method="post">
        <div class="modal-body">
          <p>ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          <div class="mb-3" th:if="${post.secret}">
            <label for="deletePassword" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="deletePassword" name="password" class="form-control form-input-sm"
                   placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="custom-btn custom-btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="submit" class="custom-btn custom-btn-danger">ì‚­ì œ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ëŒ“ê¸€ ì‘ì„± ëª¨ë‹¬ -->
<div class="modal fade" id="commentWriteModal" tabindex="-1" aria-labelledby="commentWriteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commentWriteModalLabel">
          <i class="bi bi-pencil-square"></i> <span id="modalTitle">ëŒ“ê¸€ ì‘ì„±</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="commentForm">
        <div class="modal-body">
          <!-- ëŒ€ëŒ“ê¸€ ëŒ€ìƒ í‘œì‹œ -->
          <div id="replyToInfo" class="alert alert-info" style="display: none;">
            <i class="bi bi-reply"></i> <strong><span id="replyToName"></span></strong>ë‹˜ì—ê²Œ ë‹µê¸€ ì‘ì„± ì¤‘
            <button type="button" class="btn-close float-end" onclick="resetCommentModal()"></button>
          </div>

          <!-- ëŒ€ëŒ“ê¸€ìš© hidden input -->
          <input type="hidden" id="parentId" name="parentId" value="">

          <div class="mb-3">
            <label for="commentAuthor" class="form-label">
              <i class="bi bi-person"></i> ì´ë¦„ <span class="text-danger">*</span>
            </label>
            <input type="text"
                   id="commentAuthor"
                   name="authorName"
                   class="form-control form-input-sm"
                   placeholder="ì´ë¦„ ì…ë ¥"
                   th:value="${#authentication.name == 'anonymousUser' ? '' : #authentication.principal.nickname}"
                   required>
          </div>
          <div class="mb-3">
            <label for="commentPassword" class="form-label">
              <i class="bi bi-lock"></i> ë¹„ë°€ë²ˆí˜¸ (ì„ íƒ)
            </label>
            <input type="password" id="commentPassword" name="password" class="form-control form-input-sm"
                   placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <small class="form-text text-muted">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ë©´ ì‚­ì œ ì‹œ ë³¸ì¸ í™•ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
          </div>
          <div class="mb-3">
            <label for="commentContent" class="form-label">
              <i class="bi bi-chat-text"></i> ë‚´ìš© <span class="text-danger">*</span>
            </label>
            <textarea id="commentContent" name="content" class="form-control form-input-sm" rows="5"
                      placeholder="ë‚´ìš© ì…ë ¥" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="custom-btn custom-btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i> ì·¨ì†Œ
          </button>
          <button type="submit" class="custom-btn custom-btn-primary" id="submitCommentBtn">
            <i class="bi bi-send me-1"></i> ë“±ë¡
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ëŒ“ê¸€ ì‚­ì œ ëª¨ë‹¬ -->
<div class="modal fade" id="deleteCommentModal" tabindex="-1" aria-labelledby="deleteCommentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteCommentModalLabel">ëŒ“ê¸€ ì‚­ì œ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="deleteCommentForm" method="post">
        <!-- CSRF í† í° ì¶”ê°€ -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div class="modal-body">
          <p>ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          <div class="mb-3" id="commentPasswordGroup" style="display: none;">
            <label for="commentDeletePassword" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="commentDeletePassword" name="password" class="form-control"
                   placeholder="ëŒ“ê¸€ ì‘ì„± ì‹œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="custom-btn custom-btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="submit" class="custom-btn custom-btn-danger">ì‚­ì œ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ì˜¤ë¥˜ ì•Œë¦¼ ì‹œìŠ¤í…œ JS -->
<script th:src="@{/js/error-notification.js}"></script>

<script th:inline="javascript">
  /**
   * ëŒ€ëŒ“ê¸€ ì‘ì„± ì„¤ì •
   * - ëŒ“ê¸€ì˜ "ë‹µê¸€" ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
   * - ë¶€ëª¨ ëŒ“ê¸€ ID ì„¤ì • ë° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
   */
  function setReplyTo(parentId, parentAuthor) {
    document.getElementById('parentId').value = parentId;
    document.getElementById('replyToName').textContent = parentAuthor;
    document.getElementById('replyToInfo').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'ë‹µê¸€ ì‘ì„±';
  }

  /**
   * ëŒ“ê¸€ ëª¨ë‹¬ ì´ˆê¸°í™”
   * - ì¼ë°˜ ëŒ“ê¸€ ì‘ì„± ëª¨ë“œë¡œ ì „í™˜
   * - ëŒ€ëŒ“ê¸€ ì •ë³´ ì´ˆê¸°í™”
   */
  function resetCommentModal() {
    document.getElementById('parentId').value = '';
    document.getElementById('replyToInfo').style.display = 'none';
    document.getElementById('modalTitle').textContent = 'ëŒ“ê¸€ ì‘ì„±';
    document.getElementById('commentContent').value = '';
  }

  /**
   * ëŒ“ê¸€ ì‚­ì œ ëª¨ë‹¬ ì—´ê¸°
   * - ë¹„ë°€ë²ˆí˜¸ ì„¤ì •ëœ ëŒ“ê¸€ì€ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ í‘œì‹œ
   */
  function openDeleteCommentModal(button) {
    const commentId = button.getAttribute('data-comment-id');
    const hasPassword = button.getAttribute('data-has-password') === 'true';
    const postId = /*[[${post.id}]]*/ '';

    const form = document.getElementById('deleteCommentForm');
    form.action = '/counsel/detail/' + postId + '/comments/' + commentId + '/delete';

    const passwordGroup = document.getElementById('commentPasswordGroup');
    const passwordInput = document.getElementById('commentDeletePassword');

    if (hasPassword) {
      passwordGroup.style.display = 'block';
      passwordInput.required = true;
    } else {
      passwordGroup.style.display = 'none';
      passwordInput.required = false;
    }

    const modal = new bootstrap.Modal(document.getElementById('deleteCommentModal'));
    modal.show();
  }

  /**
   * í˜ì´ì§€ ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
   */
  document.addEventListener('DOMContentLoaded', function() {
    // === ì•„ì½”ë””ì–¸ íŒ¨ë„ ì´ˆê¸° ìƒíƒœ ê°•ì œ ì„¤ì • ===
    const likePanel = document.getElementById('likeAccordionPanel');
    const commentPanel = document.getElementById('commentAccordionPanel');
    const likeHeader = document.getElementById('likeAccordionHeader');
    const commentHeader = document.getElementById('commentAccordionHeader');

    // ì¢‹ì•„ìš” íŒ¨ë„: ë‹«í˜ ìƒíƒœ ê°•ì œ ì„¤ì •
    if (likePanel) {
      likePanel.classList.remove('show');
      likePanel.style.height = '';
    }

    // ë‹µë³€ íŒ¨ë„: ì—´ë¦¼ ìƒíƒœ ìœ ì§€ (show í´ë˜ìŠ¤ëŠ” HTMLì— ìˆìŒ)
    // (ë³„ë„ ì¡°ì‘ ë¶ˆí•„ìš”)

    // í™”ì‚´í‘œ ì´ˆê¸° ë°©í–¥ ê°•ì œ ì„¤ì •
    // ì¢‹ì•„ìš”: ë‹«í˜ â†’ ìœ„ ë°©í–¥ (180deg)
    // ë‹µë³€: ì—´ë¦¼ â†’ ì•„ë˜ ë°©í–¥ (0deg)
    if (likeHeader) {
      const likeIcon = likeHeader.querySelector('.accordion-toggle-icon i');
      if (likeIcon) {
        likeIcon.style.transform = 'rotate(180deg)'; // ìœ„ ë°©í–¥
      }
    }
    if (commentHeader) {
      const commentIcon = commentHeader.querySelector('.accordion-toggle-icon i');
      if (commentIcon) {
        commentIcon.style.transform = 'rotate(0deg)'; // ì•„ë˜ ë°©í–¥
      }
    }

    // Flash ë©”ì‹œì§€ë¥¼ TOASTë¡œ ë³€í™˜
    const successMessage = /*[[${message}]]*/ null;
    const errorMessage = /*[[${error}]]*/ null;

    if (successMessage) {
      TOAST.showSuccess(successMessage, 3000);
      // Bootstrap Alert ìˆ¨ê¸°ê¸°
      const alertElement = document.querySelector('.alert-success');
      if (alertElement) {
        alertElement.style.display = 'none';
      }
    }

    if (errorMessage) {
      TOAST.showError(errorMessage, 5000);
      // Bootstrap Alert ìˆ¨ê¸°ê¸°
      const alertElement = document.querySelector('.alert-danger');
      if (alertElement) {
        alertElement.style.display = 'none';
      }
    }

    // ëŒ“ê¸€ ì‘ì„± ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì´ˆê¸°í™”
    const openCommentModalBtn = document.getElementById('openCommentModalBtn');
    if (openCommentModalBtn) {
      openCommentModalBtn.addEventListener('click', function(e) {
        e.preventDefault();
        resetCommentModal(); // ëª¨ë‹¬ ì—´ê¸° ì „ì— ì´ˆê¸°í™”
      });
    }

    // ëª¨ë‹¬ show ì´ë²¤íŠ¸ í›„ í¬ì»¤ìŠ¤ ì„¤ì •
    const commentModal = document.getElementById('commentWriteModal');
    if (commentModal) {
      commentModal.addEventListener('show.bs.modal', function() {
        // ëª¨ë‹¬ì´ í‘œì‹œë  ë•Œ ëŒ“ê¸€ ë‚´ìš© í•„ë“œì— í¬ì»¤ìŠ¤
        setTimeout(() => {
          document.getElementById('commentContent').focus();
        }, 100);
      });
    }

    // ë‹µê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ - ë™ì  ë²„íŠ¼ë„ ì§€ì›)
    document.addEventListener('click', function(e) {
      if (e.target.closest('.reply-btn')) {
        const btn = e.target.closest('.reply-btn');
        const commentId = btn.getAttribute('data-comment-id');
        const authorName = btn.getAttribute('data-author-name');
        setReplyTo(commentId, authorName);
        // ëª¨ë‹¬ ì—´ê¸°
        const modal = new bootstrap.Modal(document.getElementById('commentWriteModal'));
        modal.show();
      }
    });

    // ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ - ë™ì  ë²„íŠ¼ë„ ì§€ì›)
    document.addEventListener('click', function(e) {
      if (e.target.closest('.delete-comment-btn')) {
        const btn = e.target.closest('.delete-comment-btn');
        openDeleteCommentModal(btn);
      }
    });

    // ëŒ“ê¸€ í¼ AJAX ì œì¶œ
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
      commentForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const authorName = document.getElementById('commentAuthor').value.trim();
        const content = document.getElementById('commentContent').value.trim();

        if (!authorName) {
          TOAST.showError('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 3000);
          return;
        }

        if (!content) {
          TOAST.showError('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 3000);
          return;
        }

        const postId = /*[[${post.id}]]*/ '';
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        const formData = new FormData(this);
        const submitBtn = document.getElementById('submitCommentBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ë“±ë¡ ì¤‘...';

        fetch('/counsel/detail/' + postId + '/comments', {
          method: 'POST',
          headers: {
            [csrfHeader]: csrfToken
          },
          body: formData
        })
        .then(response => {
          if (!response.ok) {
            return response.text().then(text => Promise.reject(text));
          }
          return response.text();
        })
        .then(() => {
          // ëª¨ë‹¬ ë‹«ê¸°
          const modal = bootstrap.Modal.getInstance(document.getElementById('commentWriteModal'));
          modal.hide();

          // í¼ ì´ˆê¸°í™”
          resetCommentModal();
          commentForm.reset();

          // Toast ì•Œë¦¼
          TOAST.showSuccess('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 2000);

          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ê°„ë‹¨í•œ êµ¬í˜„)
          setTimeout(() => {
            window.location.reload();
          }, 500);
        })
        .catch(error => {
          console.error('Comment submit error:', error);
          TOAST.showError('ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 3000);
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-send me-1"></i> ë“±ë¡';
        });
      });
    }

    // ëŒ“ê¸€ ì‚­ì œ í¼ ì œì¶œ ì‹œ ê²€ì¦
    const deleteCommentForm = document.getElementById('deleteCommentForm');
    if (deleteCommentForm) {
      deleteCommentForm.addEventListener('submit', function(e) {
        const passwordInput = document.getElementById('commentDeletePassword');
        if (passwordInput && passwordInput.required && !passwordInput.value.trim()) {
          e.preventDefault();
          ErrorNotification.showToast('ì…ë ¥ ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning', 3000);
          return false;
        }
        return true;
      });
    }
  });

  /**
   * ì¢‹ì•„ìš” í† ê¸€ (AJAX)
   * - ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê°€ëŠ¥
   * - í•˜íŠ¸ ì•„ì´ì½˜ ë° ê°œìˆ˜ ì—…ë°ì´íŠ¸
   * - ì•„ì½”ë””ì–¸ í¼ì¹¨/ì ‘í˜ê³¼ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘
   */
  function toggleLike(event) {
    // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ (ì•„ì½”ë””ì–¸ í† ê¸€ê³¼ ë…ë¦½)
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    const postId = /*[[${post.id}]]*/ '';
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch('/counsel/detail/' + postId + '/like', {
      method: 'POST',
      headers: {
        [csrfHeader]: csrfToken,
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // íƒ­ì˜ í•˜íŠ¸ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
        const likeIcon = document.getElementById('likeIcon');
        if (data.liked) {
          // ì¢‹ì•„ìš” ì¶”ê°€ë¨ (ë¹¨ê°„ í•˜íŠ¸)
          likeIcon.className = 'fa fa-heart text-danger';
        } else {
          // ì¢‹ì•„ìš” ì·¨ì†Œë¨ (ë¹ˆ í•˜íŠ¸)
          likeIcon.className = 'fa fa-heart-o';
        }

        // ì¢‹ì•„ìš” ê°œìˆ˜ ì—…ë°ì´íŠ¸ (íƒ­ë§Œ)
        document.getElementById('likeCountTab').textContent = data.likeCount;

        // Toast ì•Œë¦¼
        TOAST.showSuccess(data.message, 2000);
      } else {
        // ì—ëŸ¬ (ë¹„ë¡œê·¸ì¸ ë“±)
        TOAST.showError(data.error, 3000);
      }
    })
    .catch(error => {
      console.error('Like toggle error:', error);
      TOAST.showError('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 3000);
    });
  }


  /**
   * ìƒí˜¸ ë°°íƒ€ì  ì•„ì½”ë””ì–¸ ë™ì‘ + í™”ì‚´í‘œ íšŒì „ ì• ë‹ˆë©”ì´ì…˜
   * - ì¢‹ì•„ìš” íŒ¨ë„ì„ ì—´ë©´ ë‹µë³€ íŒ¨ë„ì„ ë‹«ìŒ
   * - ë‹µë³€ íŒ¨ë„ì„ ì—´ë©´ ì¢‹ì•„ìš” íŒ¨ë„ì„ ë‹«ìŒ
   * - í™”ì‚´í‘œê°€ ìì—°ìŠ¤ëŸ½ê²Œ íšŒì „ (CSS transition í™œìš©)
   * - ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€ (í˜ì´ì§€ ì í”„ ë°©ì§€)
   */
  (function initAccordionBehavior() {
    const likePanel = document.getElementById('likeAccordionPanel');
    const likeHeader = document.getElementById('likeAccordionHeader');
    const likeToggleIcon = likeHeader.querySelector('.accordion-toggle-icon i');

    const commentPanel = document.getElementById('commentAccordionPanel');
    const commentHeader = document.getElementById('commentAccordionHeader');
    const commentToggleIcon = commentHeader.querySelector('.accordion-toggle-icon i');

    // === í—¤ë” í´ë¦­ ì‹œ ìŠ¤í¬ë¡¤ ë°©ì§€ + ìˆ˜ë™ í† ê¸€ ===
    likeHeader.addEventListener('click', function(e) {
      e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ìŠ¤í¬ë¡¤ ì í”„ ë°©ì§€)
      const likeCollapse = bootstrap.Collapse.getOrCreateInstance(likePanel);
      likeCollapse.toggle(); // ìˆ˜ë™ í† ê¸€
    });

    commentHeader.addEventListener('click', function(e) {
      e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ìŠ¤í¬ë¡¤ ì í”„ ë°©ì§€)
      const commentCollapse = bootstrap.Collapse.getOrCreateInstance(commentPanel);
      commentCollapse.toggle(); // ìˆ˜ë™ í† ê¸€
    });

    // === ì¢‹ì•„ìš” íŒ¨ë„ ì´ë²¤íŠ¸ ===
    likePanel.addEventListener('show.bs.collapse', function() {
      // ì¢‹ì•„ìš” íŒ¨ë„ ì—´ê¸° â†’ í™”ì‚´í‘œ ì•„ë˜ ë°©í–¥ (0deg)
      if (likeToggleIcon) {
        likeToggleIcon.style.transform = 'rotate(0deg)';
      }

      // ë‹µë³€ íŒ¨ë„ ë‹«ê¸° (ë‹¤ë¥¸ íŒ¨ë„ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ)
      if (commentPanel.classList.contains('show')) {
        const commentCollapse = bootstrap.Collapse.getOrCreateInstance(commentPanel);
        commentCollapse.hide();
      }
    });

    likePanel.addEventListener('hide.bs.collapse', function() {
      // ì¢‹ì•„ìš” íŒ¨ë„ ë‹«ê¸° â†’ í™”ì‚´í‘œ ìœ„ ë°©í–¥ (180deg)
      if (likeToggleIcon) {
        likeToggleIcon.style.transform = 'rotate(180deg)';
      }
      // ë‹¤ë¥¸ íŒ¨ë„ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ (ê·¸ëŒ€ë¡œ ìœ ì§€)
    });

    // === ë‹µë³€ íŒ¨ë„ ì´ë²¤íŠ¸ ===
    commentPanel.addEventListener('show.bs.collapse', function() {
      // ë‹µë³€ íŒ¨ë„ ì—´ê¸° â†’ í™”ì‚´í‘œ ì•„ë˜ ë°©í–¥ (0deg)
      if (commentToggleIcon) {
        commentToggleIcon.style.transform = 'rotate(0deg)';
      }

      // ì¢‹ì•„ìš” íŒ¨ë„ ë‹«ê¸° (ë‹¤ë¥¸ íŒ¨ë„ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ)
      if (likePanel.classList.contains('show')) {
        const likeCollapse = bootstrap.Collapse.getOrCreateInstance(likePanel);
        likeCollapse.hide();
      }
    });

    commentPanel.addEventListener('hide.bs.collapse', function() {
      // ë‹µë³€ íŒ¨ë„ ë‹«ê¸° â†’ í™”ì‚´í‘œ ìœ„ ë°©í–¥ (180deg)
      if (commentToggleIcon) {
        commentToggleIcon.style.transform = 'rotate(180deg)';
      }
      // ë‹¤ë¥¸ íŒ¨ë„ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ (ê·¸ëŒ€ë¡œ ìœ ì§€)
    });

    // === í—¤ë” í˜¸ë²„ íš¨ê³¼ ===
    [likeHeader, commentHeader].forEach(header => {
      header.addEventListener('mouseenter', function() {
        this.style.backgroundColor = '#e9ecef';
      });
      header.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '#f8f9fa';
      });
    });
  })();
</script>

</div> <!-- /container -->
</div> <!-- /wrapper div -->
