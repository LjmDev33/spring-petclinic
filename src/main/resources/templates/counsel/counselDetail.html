<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <title>온라인 상담 상세 - Spring PetClinic</title>
  <link rel="stylesheet" th:href="@{/css/custom-buttons.css}">
  <!-- 오류 알림 시스템 CSS -->
  <link rel="stylesheet" th:href="@{/css/error-notification.css}">
  <!-- 댓글 스타일 CSS -->
  <link rel="stylesheet" th:href="@{/css/comment-styles.css}">

  <!-- 아코디언 애니메이션 CSS -->
  <style>
    /* 아코디언 헤더 */
    .accordion-header {
      user-select: none;
      border-radius: 0;
    }

    .accordion-header:hover {
      background-color: #e9ecef !important;
    }

    /* 아코디언 토글 아이콘 (화살표) 회전 애니메이션 */
    .accordion-toggle-icon i {
      display: inline-block;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 아코디언 본문 */
    .accordion-body {
      padding: 1.5rem;
    }

    /* 패널 높이 변경 애니메이션 */
    .collapse {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .collapse.show {
      overflow: visible;
    }

    /* 아코디언 헤더 폰트 */
    .accordion-header .fw-bold {
      font-weight: 600;
      color: #212529;
    }

    /* 갭 스타일 */
    .accordion-header .gap-2 {
      gap: 0.75rem;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <!-- Flash 메시지 표시 -->
  <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${message}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div class="container-fluid px-0">
    <!-- 버튼 그룹 -->
    <div class="d-flex justify-content-between mb-3">
      <div class="d-flex" style="gap: 8px;">
        <!-- 수정 버튼 -->
        <a th:href="@{/counsel/edit/{id}(id=${post.id})}" class="custom-btn custom-btn-warning">
          <i class="bi bi-pencil me-1"></i> 수정
        </a>
        <!-- 삭제 버튼 -->
        <button type="button" class="custom-btn custom-btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
          <i class="bi bi-trash me-1"></i> 삭제
        </button>
      </div>
      <a th:href="@{/counsel/list}" class="custom-btn custom-btn-secondary">
        <i class="bi bi-list me-1"></i> 목록
      </a>
    </div>

    <div class="row">
      <hr class="mt-md-2 border-2 opacity-25"/>
      <h1><span th:text="${post.title}"></span></h1>
      <hr class="mt-md-2 border-1 opacity-25"/>
      <div class="d-md-flex gap-4">
        <h3 class="mb-0">작성자 : <span class="opacity-75" th:text="${post.authorName}"></span></h3>
        <h3 class="mb-0">작성일 : <span class="opacity-75" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></span></h3>
        <h3 class="mb-0">조회 : <span class="opacity-75" th:text="${post.viewCount}"></span></h3>
      </div>
    </div>

    <!-- 관리자 전용: 상태 변경 -->
    <div class="row mt-3" sec:authorize="hasRole('ADMIN')">
      <div class="col-12">
        <div class="card border-warning">
          <div class="card-body">
            <h5 class="card-title">
              <i class="bi bi-shield-check text-warning"></i> 관리자 기능
            </h5>
            <form th:action="@{/counsel/detail/{id}/status(id=${post.id})}" method="post" class="d-flex align-items-center gap-2">
              <label for="statusSelect" class="form-label mb-0">상태 변경:</label>
              <select id="statusSelect" name="status" class="form-select" style="width: auto;">
                <option value="WAIT" th:selected="${post.status.name() == 'WAIT'}">답변대기</option>
                <option value="COMPLETE" th:selected="${post.status.name() == 'COMPLETE'}">답변완료</option>
                <option value="END" th:selected="${post.status.name() == 'END'}">상담종료</option>
              </select>
              <button type="submit" class="btn btn-warning btn-sm">
                <i class="bi bi-arrow-clockwise"></i> 변경
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-md-2">
      <div class="table table-bordered">
        <div class="p-3" th:utext="${post.content}"></div>
      </div>
    </div>

    <!-- 첨부파일 표시 -->
    <div class="row mt-3" th:if="${post.attachments != null and !post.attachments.isEmpty()}">
      <div class="col-12">
        <h5><i class="bi bi-paperclip"></i> 첨부파일</h5>
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between align-items-center" th:each="file : ${post.attachments}">
            <a th:href="@{/counsel/download/{fileId}(fileId=${file.id})}" th:text="${file.originalFileName}"></a>
            <span class="badge bg-secondary rounded-pill" th:text="${#numbers.formatDecimal(file.fileSize / 1024, 1, 2)} + ' KB'"></span>
          </li>
        </ul>
      </div>
    </div>

    <!-- 좋아요/답변 탭 헤더 + 패널 영역 -->
    <div class="row mt-5">
      <div class="col-12">
        <!-- 탭 헤더 (같은 줄에 배치) -->
        <div class="d-flex border rounded-top" id="tabContainer" style="background-color: #f8f9fa;">

          <!-- 좋아요 헤더 -->
          <div class="accordion-header d-flex align-items-center p-3"
               id="likeAccordionHeader"
               style="cursor: pointer; transition: background-color 0.3s ease; width: auto; border-right: 1px solid #dee2e6; gap: 8px;"
               data-bs-toggle="collapse" data-bs-target="#likeAccordionPanel"
               aria-expanded="false" aria-controls="likeAccordionPanel">

            <!-- 좋아요 하트 아이콘 (클릭 시 토글) -->
            <span id="likeButton" style="cursor: pointer; font-size: 1.2rem;"
                  onclick="toggleLike(event)"
                  title="좋아요를 누르려면 로그인하세요">
              <i id="likeIcon" th:class="${isLiked} ? 'fa fa-heart text-danger' : 'fa fa-heart-o'"></i>
            </span>

            <!-- 텍스트 -->
            <span class="fw-bold">좋아요 (<span id="likeCountTab" th:text="${likeCount}">0</span>)</span>

            <!-- 아코디언 화살표 (오른쪽 끝) -->
            <span class="accordion-toggle-icon" style="display: inline-flex; align-items: center; transition: transform 0.3s ease; margin-left: auto;">
              <i class="fa fa-chevron-down"></i>
            </span>
          </div>

          <!-- 답변 헤더 -->
          <div class="accordion-header d-flex align-items-center p-3"
               id="commentAccordionHeader"
               style="cursor: pointer; transition: background-color 0.3s ease; width: auto; gap: 8px;"
               data-bs-toggle="collapse" data-bs-target="#commentAccordionPanel"
               aria-expanded="false" aria-controls="commentAccordionPanel">

            <!-- 채팅 아이콘 -->
            <i class="bi bi-chat-dots"></i>

            <!-- 텍스트 -->
            <span class="fw-bold">답변 (<span th:text="${#lists.size(comments)}">0</span>)</span>

            <!-- 아코디언 화살표 (오른쪽 끝) -->
            <span class="accordion-toggle-icon" style="display: inline-flex; align-items: center; transition: transform 0.3s ease; margin-left: auto;">
              <i class="fa fa-chevron-down"></i>
            </span>
          </div>
        </div>

        <!-- 좋아요 패널 -->
        <div class="collapse border border-top-0 rounded-bottom" id="likeAccordionPanel"
             data-bs-parent="#tabContainer"
             style="transition: max-height 0.3s ease;">
          <div class="accordion-body p-4 bg-light">
                <!-- 비로그인 사용자 안내 -->
                <div sec:authorize="!isAuthenticated()" class="alert alert-info text-center mb-4">
                  <i class="fa fa-info-circle me-2"></i>좋아요를 누르려면 로그인이 필요합니다.
                </div>

                <!-- 좋아요 누른 사용자 목록 -->
                <div th:if="${likedUsers != null and !likedUsers.isEmpty()}">
                  <h5 class="mb-3 fw-bold text-center">📌 이 글에 공감한 사용자</h5>
                  <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                    <!-- 사용자 목록 -->
                    <div th:each="user : ${likedUsers}" style="flex: 0 1 auto;">
                      <div class="d-flex align-items-center p-2 border rounded bg-white">
                        <!-- 프로필 이미지 또는 이니셜 아바타 -->
                        <div th:if="${user.hasProfileImage()}"
                             class="rounded-circle me-2 flex-shrink-0"
                             th:style="'width: 36px; height: 36px; background-image: url(' + ${user.profileImageUrl} + '); background-size: cover; background-position: center;'">
                        </div>
                        <div th:unless="${user.hasProfileImage()}"
                             class="rounded-circle me-2 flex-shrink-0 d-flex align-items-center justify-content-center text-white fw-bold"
                             th:style="'width: 36px; height: 36px; background-color: ' + ${user.avatarColor} + '; font-size: 14px;'"
                             th:text="${user.initial}">
                        </div>
                        <!-- 닉네임 -->
                        <span class="fw-bold text-truncate" th:text="${user.nickname}" th:title="${user.nickname}">사용자</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 좋아요 없을 때 안내 -->
                <div th:if="${likedUsers == null or likedUsers.isEmpty()}" class="alert alert-light text-center">
                  <i class="fa fa-heart-o me-2"></i>아직 좋아요를 누른 사용자가 없습니다.
                </div>
              </div>
            </div>
        </div>

        <!-- 답변 패널 -->
        <div class="collapse border border-top-0 rounded-bottom" id="commentAccordionPanel"
             data-bs-parent="#tabContainer"
             style="transition: max-height 0.3s ease;">
          <div class="accordion-body p-4">

              <!-- 댓글 목록 -->
              <div id="commentsContainer">
                <!-- 댓글 없음 -->
                <div th:if="${#lists.isEmpty(comments)}" class="alert alert-light text-center py-5">
                  <i class="bi bi-chat-text fs-1 text-muted"></i>
                  <p class="mt-3 mb-0 text-muted">아직 댓글이 없습니다. 첫 댓글을 작성해보세요!</p>
                </div>

        <!-- 재귀 렌더링 프래그먼트 정의 -->
        <th:block th:fragment="commentTree(comments, depth)">
          <div th:each="c : ${comments}">
            <!-- 댓글 카드 (depth에 따라 들여쓰기) -->
            <div class="comment-item mb-2"
                 th:style="${(depth != null ? depth : 0) > 0 ? 'margin-left: ' + ((depth != null ? depth : 0) * 48) + 'px; padding-left: 20px; border-left: 3px solid #e3f2fd;' : ''}">

              <!-- 답글 대상 표시 (대댓글인 경우) -->
              <div th:if="${(depth != null ? depth : 0) > 0 && c.parentAuthorName != null}"
                   class="reply-target-info mb-1"
                   style="font-size: 0.75rem; color: #0d6efd; font-weight: 500;">
                <i class="bi bi-arrow-return-right me-1"></i>
                <span th:text="'@' + ${c.parentAuthorName} + '님에게 답글'">@작성자님에게 답글</span>
              </div>

              <!-- 댓글 카드 -->
              <div class="card shadow-sm border-0"
                   th:style="${c.staffReply ? 'border-left: 3px solid #198754 !important; border-radius: 6px; background-color: #f0fdf4;' : ((depth != null && depth > 0) ? 'border-radius: 6px; background-color: #f8f9fa;' : 'border-radius: 6px;')}">
                <div class="card-body p-2 p-md-3">
                  <!-- 댓글 헤더 -->
                  <div class="d-flex align-items-start mb-2">
                    <!-- 아바타 -->
                    <div class="flex-shrink-0">
                      <div class="avatar-circle text-white d-flex align-items-center justify-content-center"
                           th:classappend="${(depth != null && depth > 0) ? 'bg-info' : 'bg-primary'}"
                           th:style="${(depth != null && depth > 0) ? 'width: 32px; height: 32px; font-size: 13px;' : 'width: 36px; height: 36px; font-size: 16px;'} + 'border-radius: 50%; font-weight: bold;'">
                        <span th:text="${#strings.substring(c.authorName, 0, 1)}">작</span>
                      </div>
                    </div>

                    <!-- 작성자 정보 -->
                    <div class="flex-grow-1 ms-2">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <strong th:style="${(depth != null && depth > 0) ? 'font-size: 0.85rem;' : 'font-size: 0.95rem;'}"
                                  th:text="${c.authorName}">작성자</strong>

                          <!-- 답글 배지 (대댓글인 경우) -->
                          <span th:if="${depth != null && depth > 0}" class="badge bg-info ms-1" style="font-size: 0.65rem;">
                            <i class="bi bi-reply-fill"></i> 답글
                          </span>

                          <!-- 운영자 배지 -->
                          <span th:if="${c.staffReply}" class="badge bg-success ms-1"
                                th:style="${(depth != null && depth > 0) ? 'font-size: 0.65rem;' : 'font-size: 0.7rem;'}">
                            <i class="bi bi-shield-check"></i> 운영자
                          </span>
                        </div>

                        <!-- 작성 시간 -->
                        <small class="text-muted" th:style="${(depth != null && depth > 0) ? 'font-size: 0.75rem;' : 'font-size: 0.8rem;'}">
                          <i class="bi bi-clock"></i>
                          <span th:text="${#temporals.format(c.createdAt, 'MM-dd HH:mm')}"></span>
                        </small>
                      </div>
                    </div>
                  </div>

                  <!-- 댓글 내용 -->
                  <div class="comment-content ps-0 ps-md-5 mb-2"
                       th:text="${c.content}"
                       th:style="${(depth != null && depth > 0) ? 'font-size: 0.85rem; line-height: 1.4; color: #555;' : 'font-size: 0.9rem; line-height: 1.5; color: #333;'} + 'word-break: break-word; white-space: pre-wrap;'"></div>

                  <!-- 댓글 액션 버튼 -->
                  <div class="d-flex justify-content-end ps-0 ps-md-5 gap-1">
                    <!-- 답글 버튼 -->
                    <button type="button"
                            class="btn btn-sm btn-outline-primary reply-btn"
                            th:style="${(depth != null && depth > 0) ? 'font-size: 0.75rem; padding: 0.2rem 0.4rem;' : 'font-size: 0.8rem; padding: 0.25rem 0.5rem;'}"
                            data-bs-toggle="modal"
                            data-bs-target="#commentWriteModal"
                            th:attr="data-comment-id=${c.id},data-author-name=${c.authorName}">
                      <i class="bi bi-reply"></i> 답글
                    </button>

                    <!-- 삭제 버튼 (운영자 댓글 제외) -->
                    <button type="button"
                            class="btn btn-sm btn-outline-danger delete-comment-btn"
                            th:style="${(depth != null && depth > 0) ? 'font-size: 0.75rem; padding: 0.2rem 0.4rem;' : 'font-size: 0.8rem; padding: 0.25rem 0.5rem;'}"
                            th:if="${!c.staffReply}"
                            th:attr="data-comment-id=${c.id},data-has-password=${c.passwordHash != null}">
                      <i class="bi bi-trash"></i> 삭제
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 자식 댓글 재귀 렌더링 -->
            <th:block th:if="${!#lists.isEmpty(c.children)}"
                      th:replace="~{:: commentTree(${c.children}, ${(depth != null ? depth : 0) + 1})}">
            </th:block>
          </div>
        </th:block>

        <div th:if="${!#lists.isEmpty(comments)}">
          <!-- 댓글 컨테이너 -->
          <div class="comments-container">
            <!-- 재귀 렌더링 시작 (depth 0부터) -->
            <th:block th:replace="~{:: commentTree(${comments}, 0)}"></th:block>
          </div>

          <!-- 댓글 작성 버튼 (하단 우측) -->
          <div class="d-flex justify-content-end mt-4">
            <button type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#commentWriteModal"
                    id="openCommentModalBtn">
              <i class="bi bi-pencil-square"></i> 댓글 작성
            </button>
          </div>
        </div>
          </div>
        </div>
      </div> <!-- /col-12 -->
    </div> <!-- /row -->
  </div> <!-- /container-fluid -->
</div> <!-- /container -->
  </div> <!-- /container-fluid -->
</div> <!-- /container -->

<!-- 게시글 삭제 모달 -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">게시글 삭제</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form th:action="@{/counsel/delete/{id}(id=${post.id})}" method="post">
        <div class="modal-body">
          <p>정말로 이 게시글을 삭제하시겠습니까?</p>
          <div class="mb-3" th:if="${post.secret}">
            <label for="deletePassword" class="form-label">비밀번호 확인</label>
            <input type="password" id="deletePassword" name="password" class="form-control form-input-sm"
                   placeholder="비밀번호 입력" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="custom-btn custom-btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="custom-btn custom-btn-danger">삭제</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 댓글 작성 모달 -->
<div class="modal fade" id="commentWriteModal" tabindex="-1" aria-labelledby="commentWriteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commentWriteModalLabel">
          <i class="bi bi-pencil-square"></i> <span id="modalTitle">댓글 작성</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form th:action="@{/counsel/detail/{postId}/comments(postId=${post.id})}" method="post" id="commentForm">
        <div class="modal-body">
          <!-- 대댓글 대상 표시 -->
          <div id="replyToInfo" class="alert alert-info" style="display: none;">
            <i class="bi bi-reply"></i> <strong><span id="replyToName"></span></strong>님에게 답글 작성 중
            <button type="button" class="btn-close float-end" onclick="resetCommentModal()"></button>
          </div>

          <!-- 대댓글용 hidden input -->
          <input type="hidden" id="parentId" name="parentId" value="">

          <div class="mb-3">
            <label for="commentAuthor" class="form-label">
              <i class="bi bi-person"></i> 이름 <span class="text-danger">*</span>
            </label>
            <input type="text"
                   id="commentAuthor"
                   name="authorName"
                   class="form-control form-input-sm"
                   placeholder="이름 입력"
                   th:value="${#authentication != null && #authentication.principal != null && #authentication.principal.nickname != null ? #authentication.principal.nickname : ''}"
                   required>
          </div>
          <div class="mb-3">
            <label for="commentPassword" class="form-label">
              <i class="bi bi-lock"></i> 비밀번호 (선택)
            </label>
            <input type="password" id="commentPassword" name="password" class="form-control form-input-sm"
                   placeholder="비밀번호 입력">
            <small class="form-text text-muted">비밀번호를 설정하면 삭제 시 본인 확인이 가능합니다.</small>
          </div>
          <div class="mb-3">
            <label for="commentContent" class="form-label">
              <i class="bi bi-chat-text"></i> 내용 <span class="text-danger">*</span>
            </label>
            <textarea id="commentContent" name="content" class="form-control form-input-sm" rows="5"
                      placeholder="내용 입력" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="custom-btn custom-btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i> 취소
          </button>
          <button type="submit" class="custom-btn custom-btn-primary">
            <i class="bi bi-send me-1"></i> 등록
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 댓글 삭제 모달 -->
<div class="modal fade" id="deleteCommentModal" tabindex="-1" aria-labelledby="deleteCommentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteCommentModalLabel">댓글 삭제</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="deleteCommentForm" method="post">
        <!-- CSRF 토큰 추가 -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div class="modal-body">
          <p>정말로 이 댓글을 삭제하시겠습니까?</p>
          <div class="mb-3" id="commentPasswordGroup" style="display: none;">
            <label for="commentDeletePassword" class="form-label">비밀번호 확인</label>
            <input type="password" id="commentDeletePassword" name="password" class="form-control"
                   placeholder="댓글 작성 시 설정한 비밀번호를 입력하세요">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="custom-btn custom-btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="custom-btn custom-btn-danger">삭제</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 오류 알림 시스템 JS -->
<script th:src="@{/js/error-notification.js}"></script>

<script th:inline="javascript">
  /**
   * 대댓글 작성 설정
   * - 댓글의 "답글" 버튼 클릭 시 호출
   * - 부모 댓글 ID 설정 및 안내 메시지 표시
   */
  function setReplyTo(parentId, parentAuthor) {
    document.getElementById('parentId').value = parentId;
    document.getElementById('replyToName').textContent = parentAuthor;
    document.getElementById('replyToInfo').style.display = 'block';
    document.getElementById('modalTitle').textContent = '답글 작성';
  }

  /**
   * 댓글 모달 초기화
   * - 일반 댓글 작성 모드로 전환
   * - 대댓글 정보 초기화
   */
  function resetCommentModal() {
    document.getElementById('parentId').value = '';
    document.getElementById('replyToInfo').style.display = 'none';
    document.getElementById('modalTitle').textContent = '댓글 작성';
    document.getElementById('commentContent').value = '';
  }

  /**
   * 댓글 삭제 모달 열기
   * - 비밀번호 설정된 댓글은 비밀번호 입력 필드 표시
   */
  function openDeleteCommentModal(button) {
    const commentId = button.getAttribute('data-comment-id');
    const hasPassword = button.getAttribute('data-has-password') === 'true';
    const postId = /*[[${post.id}]]*/ '';

    const form = document.getElementById('deleteCommentForm');
    form.action = '/counsel/detail/' + postId + '/comments/' + commentId + '/delete';

    const passwordGroup = document.getElementById('commentPasswordGroup');
    const passwordInput = document.getElementById('commentDeletePassword');

    if (hasPassword) {
      passwordGroup.style.display = 'block';
      passwordInput.required = true;
    } else {
      passwordGroup.style.display = 'none';
      passwordInput.required = false;
    }

    const modal = new bootstrap.Modal(document.getElementById('deleteCommentModal'));
    modal.show();
  }

  /**
   * 페이지 로드 후 이벤트 리스너 등록
   */
  document.addEventListener('DOMContentLoaded', function() {
    // Flash 메시지를 TOAST로 변환
    const successMessage = /*[[${message}]]*/ null;
    const errorMessage = /*[[${error}]]*/ null;

    if (successMessage) {
      TOAST.showSuccess(successMessage, 3000);
      // Bootstrap Alert 숨기기
      const alertElement = document.querySelector('.alert-success');
      if (alertElement) {
        alertElement.style.display = 'none';
      }
    }

    if (errorMessage) {
      TOAST.showError(errorMessage, 5000);
      // Bootstrap Alert 숨기기
      const alertElement = document.querySelector('.alert-danger');
      if (alertElement) {
        alertElement.style.display = 'none';
      }
    }

    // 댓글 작성 버튼 클릭 시 모달 초기화
    const openCommentModalBtn = document.getElementById('openCommentModalBtn');
    if (openCommentModalBtn) {
      openCommentModalBtn.addEventListener('click', function(e) {
        e.preventDefault();
        resetCommentModal(); // 모달 열기 전에 초기화
      });
    }

    // 모달 show 이벤트 후 포커스 설정
    const commentModal = document.getElementById('commentWriteModal');
    if (commentModal) {
      commentModal.addEventListener('show.bs.modal', function() {
        // 모달이 표시될 때 댓글 내용 필드에 포커스
        setTimeout(() => {
          document.getElementById('commentContent').focus();
        }, 100);
      });
    }

    // 답글 버튼 이벤트 리스너 (이벤트 위임 방식 - 동적 버튼도 지원)
    document.addEventListener('click', function(e) {
      if (e.target.closest('.reply-btn')) {
        const btn = e.target.closest('.reply-btn');
        const commentId = btn.getAttribute('data-comment-id');
        const authorName = btn.getAttribute('data-author-name');
        setReplyTo(commentId, authorName);
        // 모달 열기
        const modal = new bootstrap.Modal(document.getElementById('commentWriteModal'));
        modal.show();
      }
    });

    // 댓글 삭제 버튼 이벤트 리스너 (이벤트 위임 방식 - 동적 버튼도 지원)
    document.addEventListener('click', function(e) {
      if (e.target.closest('.delete-comment-btn')) {
        const btn = e.target.closest('.delete-comment-btn');
        openDeleteCommentModal(btn);
      }
    });

    // 댓글 폼 제출 시 검증
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
      commentForm.addEventListener('submit', function(e) {
        const authorName = document.getElementById('commentAuthor').value.trim();
        const content = document.getElementById('commentContent').value.trim();

        if (!authorName) {
          e.preventDefault();
          ErrorNotification.showToast('입력 오류', '이름을 입력해주세요.', 'warning', 3000);
          return false;
        }

        if (!content) {
          e.preventDefault();
          ErrorNotification.showToast('입력 오류', '댓글 내용을 입력해주세요.', 'warning', 3000);
          return false;
        }

        // 정상 제출
        return true;
      });
    }

    // 댓글 삭제 폼 제출 시 검증
    const deleteCommentForm = document.getElementById('deleteCommentForm');
    if (deleteCommentForm) {
      deleteCommentForm.addEventListener('submit', function(e) {
        const passwordInput = document.getElementById('commentDeletePassword');
        if (passwordInput && passwordInput.required && !passwordInput.value.trim()) {
          e.preventDefault();
          ErrorNotification.showToast('입력 오류', '비밀번호를 입력해주세요.', 'warning', 3000);
          return false;
        }
        return true;
      });
    }
  });

  /**
   * 좋아요 토글 (AJAX)
   * - 로그인한 사용자만 가능
   * - 하트 아이콘 및 개수 업데이트
   * - 아코디언 펼침/접힘과 독립적으로 동작
   */
  function toggleLike(event) {
    // 이벤트 전파 방지 (아코디언 토글과 독립)
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    const postId = /*[[${post.id}]]*/ '';
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch('/counsel/detail/' + postId + '/like', {
      method: 'POST',
      headers: {
        [csrfHeader]: csrfToken,
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // 탭의 하트 아이콘 업데이트
        const likeIcon = document.getElementById('likeIcon');
        if (data.liked) {
          // 좋아요 추가됨 (빨간 하트)
          likeIcon.className = 'fa fa-heart text-danger';
        } else {
          // 좋아요 취소됨 (빈 하트)
          likeIcon.className = 'fa fa-heart-o';
        }

        // 좋아요 개수 업데이트 (탭만)
        document.getElementById('likeCountTab').textContent = data.likeCount;

        // Toast 알림
        TOAST.showSuccess(data.message, 2000);
      } else {
        // 에러 (비로그인 등)
        TOAST.showError(data.error, 3000);
      }
    })
    .catch(error => {
      console.error('Like toggle error:', error);
      TOAST.showError('좋아요 처리 중 오류가 발생했습니다.', 3000);
    });
  }


  /**
   * 상호 배타적 아코디언 동작 + 화살표 회전 애니메이션
   * - 좋아요 패널을 열면 답변 패널을 닫음
   * - 답변 패널을 열면 좋아요 패널을 닫음
   * - 화살표가 자연스럽게 회전 (CSS transition 활용)
   */
  (function initAccordionBehavior() {
    const likePanel = document.getElementById('likeAccordionPanel');
    const likeHeader = document.getElementById('likeAccordionHeader');
    const likeToggleIcon = likeHeader.querySelector('.accordion-toggle-icon i');

    const commentPanel = document.getElementById('commentAccordionPanel');
    const commentHeader = document.getElementById('commentAccordionHeader');
    const commentToggleIcon = commentHeader.querySelector('.accordion-toggle-icon i');

    // === 좋아요 패널 이벤트 ===
    likePanel.addEventListener('show.bs.collapse', function() {
      // 좋아요 패널 열기 → 화살표 회전 (down → up)
      if (likeToggleIcon) {
        likeToggleIcon.style.transform = 'rotate(180deg)';
      }

      // 답변 패널 닫기 (부자연스러움 방지를 위해 약간의 딜레이 추가)
      if (commentPanel.classList.contains('show')) {
        const commentCollapse = bootstrap.Collapse.getInstance(commentPanel);
        if (commentCollapse) {
          commentCollapse.hide();
        }
      }
    });

    likePanel.addEventListener('hide.bs.collapse', function() {
      // 좋아요 패널 닫기 → 화살표 회전 (up → down)
      if (likeToggleIcon) {
        likeToggleIcon.style.transform = 'rotate(0deg)';
      }
    });

    // === 답변 패널 이벤트 ===
    commentPanel.addEventListener('show.bs.collapse', function() {
      // 답변 패널 열기 → 화살표 회전 (down → up)
      if (commentToggleIcon) {
        commentToggleIcon.style.transform = 'rotate(180deg)';
      }

      // 좋아요 패널 닫기 (부자연스러움 방지를 위해 약간의 딜레이 추가)
      if (likePanel.classList.contains('show')) {
        const likeCollapse = bootstrap.Collapse.getInstance(likePanel);
        if (likeCollapse) {
          likeCollapse.hide();
        }
      }
    });

    commentPanel.addEventListener('hide.bs.collapse', function() {
      // 답변 패널 닫기 → 화살표 회전 (up → down)
      if (commentToggleIcon) {
        commentToggleIcon.style.transform = 'rotate(0deg)';
      }
    });

    // === 헤더 호버 효과 ===
    [likeHeader, commentHeader].forEach(header => {
      header.addEventListener('mouseenter', function() {
        this.style.backgroundColor = '#e9ecef';
      });
      header.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '#f8f9fa';
      });
    });
  })();
</script>

</body>
</html>
