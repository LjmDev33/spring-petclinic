<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <title>온라인 상담 글쓰기 - Spring PetClinic</title>
  <!-- Quill Editor CSS (로컬 내장) -->
  <link rel="stylesheet" th:href="@{/css/quill/quill.snow.css}">
  <!-- Uppy CSS (로컬 내장) -->
  <link rel="stylesheet" th:href="@{/css/uppy/uppy.min.css}">
  <link rel="stylesheet" th:href="@{/css/custom-buttons.css}">
</head>
<body>
<div class="container mt-4">
  <!-- 헤더: 제목 + 목록 버튼 -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="bi bi-pencil-square"></i> 온라인 상담 글쓰기
    </h2>
    <a th:href="@{/counsel/list}" class="custom-btn custom-btn-secondary" style="height: 42px; min-width: 110px; display: flex; align-items: center; justify-content: center;">
      <i class="bi bi-list me-1"></i> 목록
    </a>
  </div>
  <form id="counselForm" th:action="@{/counsel}" method="post" enctype="multipart/form-data">
    <!-- 이름 입력 -->
    <div class="mb-3">
      <label class="form-label">
        <i class="bi bi-person"></i> 이름 <span class="text-danger">*</span>
      </label>
      <input type="text" name="authorName" class="form-control" required>
    </div>

    <!-- 이메일 입력 -->
    <div class="mb-3">
      <label class="form-label">
        <i class="bi bi-envelope"></i> 이메일
      </label>
      <input type="email" name="authorEmail" class="form-control">
    </div>

    <!-- 제목 입력 -->
    <div class="mb-3">
      <label class="form-label">
        <i class="bi bi-chat-left-text"></i> 제목 <span class="text-danger">*</span>
      </label>
      <input type="text" name="title" class="form-control" required>
    </div>

    <!-- 비공개 여부 체크박스 -->
    <div class="mb-3 form-check">
      <input type="checkbox" name="secret" class="form-check-input" id="secretChk">
      <label class="form-check-label" for="secretChk">
        <i class="bi bi-lock"></i> 비공개
      </label>
    </div>

    <!-- 비밀번호 입력 (비공개 시 필수) -->
    <div class="mb-3">
      <label class="form-label">
        <i class="bi bi-key"></i> 비밀번호
      </label>
      <input type="password" name="password" class="form-control" placeholder="비공개글 열람용 비밀번호">
      <small class="form-text text-muted">비공개 글로 작성 시 입력한 비밀번호로 조회할 수 있습니다.</small>
    </div>

    <!-- 에디터 영역 -->
    <div class="mb-3">
      <label class="form-label">
        <i class="bi bi-file-text"></i> 내용 <span class="text-danger">*</span>
      </label>
      <div id="editor" style="height: 400px;"></div>
      <textarea name="content" id="content" hidden></textarea>
    </div>

    <!-- 첨부파일 입력(Uppy Dashboard 영역으로 대체) -->
    <div class="mb-3">
      <label class="form-label">
        <i class="bi bi-paperclip"></i> 첨부파일
      </label>
      <!-- 실제 서버 전송용 hidden input (Uppy 업로드된 파일 경로, 쉼표 구분) -->
      <input type="hidden" id="attachmentPaths" name="attachmentPaths">
      <!-- Uppy Dashboard가 렌더링될 영역 -->
      <div id="uppy-dashboard" class="border rounded p-2"></div>
      <small class="form-text text-muted">
        이미지 및 일반 파일을 업로드할 수 있으며, 파일당 최대 5MB, 최대 5개까지 업로드할 수 있습니다.
      </small>
    </div>

    <!-- 파일 업로드 Progress Bar (Uppy 진행상태와 연동 예정) -->
    <div class="progress mt-3 mb-3" id="uploadProgress" style="display: none; height: 35px;">
      <div class="progress-bar progress-bar-striped progress-bar-animated"
           role="progressbar"
           id="uploadProgressBar"
           aria-valuenow="0"
           aria-valuemin="0"
           aria-valuemax="100"
           style="width: 0%;">
        <span id="uploadProgressText" class="fw-bold fs-6">0%</span>
      </div>
    </div>

    <div class="d-flex justify-content-end mt-4">
      <button type="submit" class="custom-btn custom-btn-primary" id="submitBtn">
        <i class="bi bi-send me-1"></i> 작성완료
      </button>
    </div>
  </form>
</div>

<!-- Quill Editor JS (로컬 내장) -->
<script th:src="@{/js/quill/quill.js}"></script>

<!-- Uppy JS (로컬 내장) -->
<script th:src="@{/js/uppy/uppy.min.js}"></script>

<script th:inline="javascript">
  /**
   * Quill Editor 및 Uppy 초기화
   */
  document.addEventListener('DOMContentLoaded', function () {
    // Quill Editor 초기화
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'align': [] }],
          ['link'],
          ['clean']
        ]
      },
      placeholder: '상담 내용을 입력하세요...'
    });
    // Uppy 초기화 (CDN 전역 객체 사용)
    const { Uppy } = window.Uppy;
    const uppy = new Uppy({
      autoProceed: false,
      restrictions: {
        maxNumberOfFiles: 5,
        maxFileSize: 5 * 1024 * 1024, // 5MB
        allowedFileTypes: ['image/*', '.pdf', '.doc', '.docx', '.hwp', '.txt', '.zip']
      }
    });

    uppy.use(Uppy.Dashboard, {
      inline: true,
      target: '#uppy-dashboard',
      proudlyDisplayPoweredByUppy: false,
      height: 300,
      locale: {
        strings: {
          dropPasteImportBoth: '파일을 드래그하거나 %{browse}하세요',
          browse: '선택',
          uploadXFiles: {
            0: '%{smart_count}개 파일 업로드',
            1: '%{smart_count}개 파일 업로드'
          },
          uploadingXFiles: {
            0: '%{smart_count}개 파일 업로드 중',
            1: '%{smart_count}개 파일 업로드 중'
          }
        }
      }
    });

    // CSRF 토큰 가져오기
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    uppy.use(Uppy.XHRUpload, {
      endpoint: '/counsel/upload-temp',
      fieldName: 'files',
      formData: true,
      headers: {
        [csrfHeader]: csrfToken
      }
    });

    // 업로드 진행률 표시
    const progressContainer = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('uploadProgressBar');
    const progressText = document.getElementById('uploadProgressText');

    uppy.on('upload-progress', (file, progress) => {
      if (!progressContainer) return;
      progressContainer.style.display = 'block';
      const percent = Math.round((progress.bytesUploaded / progress.bytesTotal) * 100);
      progressBar.style.width = percent + '%';
      progressBar.setAttribute('aria-valuenow', String(percent));
      progressText.textContent = percent + '%';
    });

    uppy.on('complete', (result) => {
      console.log('Uppy upload complete:', result);
      if (progressContainer) {
        setTimeout(() => {
          progressContainer.style.display = 'none';
        }, 1000);
      }

      // 업로드 성공한 파일 경로들을 hidden 필드에 저장
      if (result.successful && result.successful.length > 0) {
        const filePaths = [];
        result.successful.forEach(file => {
          // 서버 응답에서 파일 정보 추출
          if (file.response && file.response.body && file.response.body.files) {
            file.response.body.files.forEach(f => {
              if (f.path) {
                filePaths.push(f.path);
              }
            });
          }
        });

        if (filePaths.length > 0) {
          document.getElementById('attachmentPaths').value = filePaths.join(',');
          console.log('Uploaded file paths:', filePaths);
        }
      }
    });

    uppy.on('upload-error', (file, error) => {
      console.error('Upload error:', error);
      alert('파일 업로드 중 오류가 발생했습니다: ' + (error.message || '알 수 없는 오류'));
    });

    // 폼 제출 시 Uppy 업로드 먼저 수행
    const form = document.getElementById('counselForm');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      // Quill 에디터 내용을 hidden textarea에 동기화
      const contentTextarea = document.getElementById('content');
      if (contentTextarea && quill) {
        contentTextarea.value = quill.root.innerHTML;
      }

      // Uppy에 파일이 있으면 업로드 먼저 수행
      if (uppy.getFiles().length > 0) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>업로드 중...';

        uppy.upload().then((result) => {
          console.log('Upload result:', result);
          form.submit();
        }).catch((error) => {
          console.error('Upload error:', error);
          alert('파일 업로드 중 오류가 발생했습니다.');
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-send me-1"></i> 작성완료';
        });
      } else {
        // 첨부파일이 없으면 바로 제출
        form.submit();
      }
    });
  });
</script>

</body>
</html>
