<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <title>온라인 상담 수정 - Spring PetClinic</title>
  <!-- Quill Editor CSS (로컬 내장) -->
  <link rel="stylesheet" th:href="@{/css/quill/quill.snow.css}">
  <!-- Uppy CSS (로컬 내장) -->
  <link rel="stylesheet" th:href="@{/css/uppy/uppy-custom.css}">
  <link rel="stylesheet" th:href="@{/css/uppy/upload-modal.css}">
  <link rel="stylesheet" th:href="@{/css/custom-buttons.css}">
  <!-- 오류 알림 시스템 CSS -->
  <link rel="stylesheet" th:href="@{/css/error-notification.css}">
</head>
<body>
<div class="container mt-4">
  <!-- 헤더: 제목 + 상세보기/목록 버튼 -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="bi bi-pencil-square"></i> 온라인 상담 수정
    </h2>
    <div class="d-flex" style="gap: 8px;">
      <a th:href="@{/counsel/detail/{id}(id=${post.id})}" class="custom-btn custom-btn-secondary">
        <i class="bi bi-arrow-left me-1"></i> 취소
      </a>
      <a th:href="@{/counsel/list}" class="custom-btn custom-btn-secondary">
        <i class="bi bi-list me-1"></i> 목록
      </a>
    </div>
  </div>

  <!-- Flash 메시지 표시 -->
  <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle-fill"></i> <span th:text="${message}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill"></i> <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <form id="editForm" th:action="@{/counsel/edit/{id}(id=${post.id})}" method="post" enctype="multipart/form-data">
    <!-- 제목 입력 -->
    <div class="mb-3">
      <label for="title" class="form-label">
        <i class="bi bi-chat-left-text"></i> 제목 <span class="text-danger">*</span>
      </label>
      <input type="text" id="title" name="title" class="form-control form-input-sm" th:value="${post.title}" required>
    </div>

    <!-- 작성자 입력 -->
    <div class="mb-3">
      <label for="authorName" class="form-label">
        <i class="bi bi-person"></i> 작성자 <span class="text-danger">*</span>
      </label>
      <input type="text" id="authorName" name="authorName" class="form-control form-input-sm" th:value="${post.authorName}" required>
    </div>

    <!-- 에디터 영역 -->
    <div class="mb-3">
      <label class="form-label">
        <i class="bi bi-file-text"></i> 내용 <span class="text-danger">*</span>
      </label>
      <div id="editor" style="height: 400px;"></div>
      <textarea name="content" id="content" hidden></textarea>
    </div>

    <!-- 기존 첨부파일 목록 -->
    <div class="mb-3" th:if="${post.attachments != null and !post.attachments.isEmpty()}">
      <label class="form-label">
        <i class="bi bi-paperclip"></i> 기존 첨부파일
      </label>
      <ul class="list-group" id="existingFilesList">
        <li class="list-group-item d-flex justify-content-between align-items-center"
            th:each="file : ${post.attachments}"
            th:data-file-id="${file.id}">
          <div>
            <i class="bi bi-file-earmark"></i>
            <span th:text="${file.originalFileName}"></span>
            <span class="badge bg-secondary rounded-pill ms-2"
                  th:text="${#numbers.formatDecimal(file.fileSize / 1024, 1, 2)} + ' KB'"></span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger"
                  th:onclick="'removeExistingFile(' + ${file.id} + ')'">
            <i class="bi bi-trash"></i> 삭제
          </button>
        </li>
      </ul>
      <!-- 삭제할 파일 ID 목록 (쉼표 구분) -->
      <input type="hidden" id="deletedFileIds" name="deletedFileIds" value="">
    </div>

    <!-- 새 첨부파일 추가 (Uppy Dashboard) -->
    <div class="mb-3">
      <label class="form-label">
        <i class="bi bi-paperclip"></i> 새 첨부파일 추가
      </label>
      <!-- 실제 서버 전송용 hidden input (Uppy 업로드된 파일 경로, 쉼표 구분) -->
      <input type="hidden" id="attachmentPaths" name="attachmentPaths">
      <!-- Uppy Dashboard가 렌더링될 영역 -->
      <div id="uppy-dashboard" class="border rounded p-2"></div>
      <small class="form-text text-muted">
        이미지, 문서(PDF, Word, Excel, 한글), 압축 파일을 업로드할 수 있으며, 파일당 최대 10MB, 최대 5개까지 업로드할 수 있습니다.
      </small>
    </div>

    <!-- 비밀번호 입력 (비공개 글인 경우) -->
    <div class="mb-3" th:if="${post.secret}">
      <label for="password" class="form-label">
        <i class="bi bi-key"></i> 비밀번호 확인 <span class="text-danger">*</span>
      </label>
      <input type="password" id="password" name="password" class="form-control form-input-sm" placeholder="비밀번호 입력" required>
      <small class="form-text text-muted">게시글 작성 시 설정한 비밀번호를 입력하세요.</small>
    </div>

    <!-- 버튼 영역: 수정완료 -->
    <div class="d-flex justify-content-end mt-4">
      <button type="submit" class="custom-btn custom-btn-primary" id="submitBtn">
        <i class="bi bi-save me-1"></i> 수정 완료
      </button>
    </div>
  </form>
</div>

<!-- 업로드 모달 (counsel-write.html과 동일) -->
<div id="uploadModal" class="upload-modal-overlay" style="display: none;">
  <div class="upload-modal">
    <div class="upload-modal-header">
      <h3 class="upload-modal-title">
        <span class="upload-spinner"></span>
        파일 업로드 중
      </h3>
      <p class="upload-modal-subtitle" id="uploadModalSubtitle">업로드를 준비하고 있습니다...</p>
    </div>
    <div class="upload-modal-body">
      <div class="upload-modal-progress">
        <div class="upload-modal-progress-bar">
          <div class="upload-modal-progress-fill" id="uploadModalProgressFill" style="width: 0%;"></div>
          <div class="upload-modal-progress-text" id="uploadModalProgressText">0%</div>
        </div>
      </div>
      <div class="upload-modal-status" id="uploadModalStatus">
        파일을 업로드하고 있습니다...
      </div>
    </div>
  </div>
</div>

<!-- Quill Editor JS (로컬 내장) -->
<script th:src="@{/js/quill/quill.js}"></script>

<!-- Uppy JS (로컬 내장 브라우저 번들) -->
<script th:src="@{/js/uppy/uppy-browser.js}"></script>

<!-- 오류 알림 시스템 JS -->
<script th:src="@{/js/error-notification.js}"></script>

<script th:inline="javascript">
  // 포맷팅 함수들 (counsel-write.html과 동일)
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  function formatSpeed(bytesPerSec) {
    if (bytesPerSec === 0) return '0 KB/s';
    const k = 1024;
    if (bytesPerSec < k) {
      return Math.round(bytesPerSec) + ' B/s';
    } else if (bytesPerSec < k * k) {
      return Math.round(bytesPerSec / k * 10) / 10 + ' KB/s';
    } else {
      return Math.round(bytesPerSec / (k * k) * 10) / 10 + ' MB/s';
    }
  }

  function formatTime(seconds) {
    if (!isFinite(seconds) || seconds < 0) return '계산 중...';
    if (seconds < 1) return '거의 완료';
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    if (h > 0) {
      return `${h}시간 ${m}분`;
    } else if (m > 0) {
      return `${m}분 ${s}초`;
    } else {
      return `${s}초`;
    }
  }

  // 기존 파일 삭제 처리
  const deletedFileIdsSet = new Set();

  function removeExistingFile(fileId) {
    try {
      const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
      const fileName = fileItem ? fileItem.querySelector('span')?.textContent : '파일';

      if (confirm(`"${fileName}"을(를) 삭제하시겠습니까?\n\n※ 게시글 수정을 완료해야 실제로 삭제됩니다.`)) {
        deletedFileIdsSet.add(fileId);
        document.getElementById('deletedFileIds').value = Array.from(deletedFileIdsSet).join(',');

        // UI에서 해당 파일 항목 제거
        if (fileItem) {
          fileItem.style.transition = 'opacity 0.3s';
          fileItem.style.opacity = '0';
          setTimeout(() => {
            fileItem.remove();
            ErrorNotification.showToast(
              '파일 삭제 예약',
              `"${fileName}" 파일이 삭제 예약되었습니다. 수정을 완료하면 삭제됩니다.`,
              'success',
              3000
            );
          }, 300);
        }

        console.log('File marked for deletion:', fileId);
      }
    } catch (error) {
      console.error('Error removing file:', error);
      ErrorNotification.handleFileDeleteError({
        message: error.message || '파일 삭제 처리 중 오류가 발생했습니다.',
        code: 'FILE_DELETE_ERROR'
      }, '파일');
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Quill Editor 초기화 및 기존 내용 로드
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'align': [] }],
          ['link'],
          ['clean']
        ]
      },
      placeholder: '상담 내용을 입력하세요...'
    });

    // 기존 게시글 내용을 에디터에 로드
    const existingContent = /*[[${post.content}]]*/ '';
    if (existingContent) {
      quill.root.innerHTML = existingContent;
    }

    // Uppy 초기화 (counsel-write.html과 동일한 설정)
    const uppy = new Uppy.Core({
      autoProceed: false,
      restrictions: {
        maxNumberOfFiles: 5,
        maxFileSize: 10 * 1024 * 1024,
        allowedFileTypes: [
          'image/*', '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.hwp', '.txt', '.zip', '.rar'
        ]
      }
    });

    uppy.use(Uppy.Dashboard, {
      inline: true,
      target: '#uppy-dashboard',
      proudlyDisplayPoweredByUppy: false,
      height: 200,
      locale: {
        strings: {
          dropPasteImportBoth: '파일을 드래그하거나 %{browse}하세요',
          browse: '선택',
          uploadXFiles: {
            0: '%{smart_count}개 파일 업로드',
            1: '%{smart_count}개 파일 업로드'
          },
          uploadingXFiles: {
            0: '%{smart_count}개 파일 업로드 중',
            1: '%{smart_count}개 파일 업로드 중'
          }
        }
      }
    });

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    uppy.use(Uppy.XHRUpload, {
      endpoint: '/counsel/upload-temp',
      fieldName: 'files',
      formData: true,
      headers: {
        [csrfHeader]: csrfToken
      }
    });

    // 모달 요소
    const uploadModal = document.getElementById('uploadModal');
    const uploadModalSubtitle = document.getElementById('uploadModalSubtitle');
    const uploadModalProgressFill = document.getElementById('uploadModalProgressFill');
    const uploadModalProgressText = document.getElementById('uploadModalProgressText');
    const uploadModalStatus = document.getElementById('uploadModalStatus');

    let totalFileSize = 0;
    let totalUploadedSize = 0;
    let uploadStartTime = 0;
    const fileProgressMap = new Map();

    uppy.on('file-added', (file) => {
      console.log('File added:', file.name, 'size:', file.size);

      // 파일 크기 검증
      if (file.size > 10 * 1024 * 1024) {
        ErrorNotification.showToast(
          '파일 크기 초과',
          `"${file.name}" 파일이 너무 큽니다. (최대 10MB)`,
          'warning',
          5000
        );
      }
    });

    // 파일 추가 제한 오류 처리
    uppy.on('restriction-failed', (file, error) => {
      console.error('Restriction failed:', file?.name, error);

      let message = '파일을 추가할 수 없습니다.';
      if (error.message.includes('exceeds maximum')) {
        message = `"${file?.name || '파일'}"의 크기가 10MB를 초과합니다.`;
      } else if (error.message.includes('file type')) {
        message = `"${file?.name || '파일'}"은(는) 지원하지 않는 파일 형식입니다.`;
      } else if (error.message.includes('maximum number')) {
        message = '최대 5개의 파일만 업로드할 수 있습니다.';
      }

      ErrorNotification.showToast('파일 추가 실패', message, 'warning', 5000);
    });

    uppy.on('upload-start', (files) => {
      totalFileSize = 0;
      totalUploadedSize = 0;
      uploadStartTime = Date.now();
      fileProgressMap.clear();

      files.forEach(file => {
        totalFileSize += file.size;
        fileProgressMap.set(file.id, 0);
      });

      uploadModal.style.display = 'flex';
      uploadModalSubtitle.textContent = `${files.length}개 파일 업로드 시작 (총 ${formatFileSize(totalFileSize)})`;
      uploadModalProgressFill.style.width = '0%';
      uploadModalProgressText.textContent = '0%';
      uploadModalStatus.textContent = '파일을 업로드하고 있습니다...';
    });

    uppy.on('upload-progress', (file, progress) => {
      const currentFileProgress = progress.bytesUploaded;
      const previousFileProgress = fileProgressMap.get(file.id) || 0;
      const uploadedDelta = currentFileProgress - previousFileProgress;

      totalUploadedSize += uploadedDelta;
      fileProgressMap.set(file.id, currentFileProgress);

      const totalPercent = totalFileSize > 0 ? Math.round((totalUploadedSize / totalFileSize) * 100) : 0;
      const filePercent = Math.round((progress.bytesUploaded / progress.bytesTotal) * 100);

      const elapsedTime = (Date.now() - uploadStartTime) / 1000;
      const uploadSpeed = elapsedTime > 0 ? totalUploadedSize / elapsedTime : 0;
      const remainingBytes = totalFileSize - totalUploadedSize;
      const remainingTime = uploadSpeed > 0 ? remainingBytes / uploadSpeed : 0;

      uploadModalProgressFill.style.width = totalPercent + '%';
      uploadModalProgressText.textContent = totalPercent + '%';

      const speedText = formatSpeed(uploadSpeed);
      const timeText = formatTime(remainingTime);
      uploadModalStatus.textContent = `${file.name} (${filePercent}%) - ${speedText} - 남은 시간: ${timeText}`;
    });

    uppy.on('complete', (result) => {
      const successCount = result.successful ? result.successful.length : 0;
      const failCount = result.failed ? result.failed.length : 0;

      if (failCount === 0) {
        uploadModalSubtitle.textContent = `업로드 완료! (${successCount}개 성공)`;
        uploadModalProgressFill.style.width = '100%';
        uploadModalProgressText.textContent = '100%';
        uploadModalStatus.textContent = '모든 파일이 성공적으로 업로드되었습니다.';
      } else {
        uploadModalSubtitle.textContent = `업로드 완료 (${successCount}개 성공, ${failCount}개 실패)`;
      }

      setTimeout(() => {
        uploadModal.style.display = 'none';
      }, 2000);

      if (result.successful && result.successful.length > 0) {
        const filePaths = [];
        result.successful.forEach(file => {
          if (file.response && file.response.body && file.response.body.files) {
            file.response.body.files.forEach(f => {
              if (f.path) {
                filePaths.push(f.path);
              }
            });
          }
        });

        if (filePaths.length > 0) {
          document.getElementById('attachmentPaths').value = filePaths.join(',');
          console.log('Uploaded file paths:', filePaths);
        }
      }
    });

    uppy.on('upload-error', (file, error, response) => {
      console.error('Upload error for file:', file.name, error, response);
      uploadModalStatus.innerHTML = `
        <span style="color: #dc3545;">
          <i class="bi bi-exclamation-triangle"></i>
          ${file.name} 업로드 실패: ${error.message || '알 수 없는 오류'}
        </span>
      `;

      // ErrorNotification으로 상세 오류 표시
      ErrorNotification.handleFileUploadError({
        message: error.message || '알 수 없는 오류',
        status: response?.status || 'N/A',
        code: error.code || 'UPLOAD_ERROR',
        fileSize: file.size
      }, file.name);
    });

    // 폼 제출 처리
    const form = document.getElementById('editForm');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      // 필수 필드 검증
      const title = document.querySelector('input[name="title"]').value.trim();
      const authorName = document.querySelector('input[name="authorName"]').value.trim();

      if (!title) {
        ErrorNotification.showToast('입력 오류', '제목을 입력해주세요.', 'warning', 3000);
        return;
      }

      if (!authorName) {
        ErrorNotification.showToast('입력 오류', '이름을 입력해주세요.', 'warning', 3000);
        return;
      }

      // Quill 에디터 내용을 hidden textarea에 동기화
      const contentTextarea = document.getElementById('content');
      if (contentTextarea && quill) {
        const editorContent = quill.root.innerHTML.trim();
        if (editorContent === '<p><br></p>' || editorContent === '') {
          ErrorNotification.showToast('입력 오류', '내용을 입력해주세요.', 'warning', 3000);
          return;
        }
        contentTextarea.value = quill.root.innerHTML;
      }

      // Uppy에 파일이 있으면 업로드 먼저 수행
      if (uppy.getFiles().length > 0) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>업로드 중...';

        uppy.upload().then((result) => {
          console.log('Upload result:', result);

          // 업로드 실패한 파일이 있으면 경고
          if (result.failed && result.failed.length > 0) {
            const failedFiles = result.failed.map(f => f.name).join(', ');
            ErrorNotification.showToast(
              '일부 파일 업로드 실패',
              `${result.failed.length}개 파일 업로드에 실패했습니다: ${failedFiles}`,
              'warning',
              5000
            );
          }

          // 성공한 파일이 있으면 제출
          if (result.successful && result.successful.length > 0) {
            form.submit();
          } else {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-save me-1"></i> 수정 완료';
            ErrorNotification.showToast(
              '업로드 실패',
              '파일 업로드에 실패하여 게시글을 수정할 수 없습니다.',
              'error',
              5000
            );
          }
        }).catch((error) => {
          console.error('Upload error:', error);

          ErrorNotification.handleNetworkError({
            message: error.message || '파일 업로드 중 네트워크 오류가 발생했습니다.'
          });

          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-save me-1"></i> 수정 완료';
        });
      } else {
        // 첨부파일이 없으면 바로 제출
        try {
          form.submit();
        } catch (error) {
          console.error('Form submit error:', error);
          ErrorNotification.handlePostSubmitError({
            message: error.message || '게시글 수정 중 오류가 발생했습니다.',
            code: 'FORM_SUBMIT_ERROR'
          }, '수정');
        }
      }
    });
  });
</script>

</body>
</html>

